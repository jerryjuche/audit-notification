<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache,no-store,must-revalidate">
  <title>Nexus Audit · Real-Time Compliance Platform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,500;12..96,600;12..96,700;12..96,800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&display=swap"
    rel="stylesheet">

  <!-- SVG Icon Sprite -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="ic-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
      <path d="M13.73 21a2 2 0 0 1-3.46 0" />
    </symbol>
    <symbol id="ic-send" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <line x1="22" y1="2" x2="11" y2="13" />
      <polygon points="22 2 15 22 11 13 2 9 22 2" />
    </symbol>
    <symbol id="ic-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
      <circle cx="9" cy="7" r="4" />
      <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
      <path d="M16 3.13a4 4 0 0 1 0 7.75" />
    </symbol>
    <symbol id="ic-radio" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <circle cx="12" cy="12" r="2" />
      <path
        d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14" />
    </symbol>
    <symbol id="ic-upload" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
      <polyline points="17 8 12 3 7 8" />
      <line x1="12" y1="3" x2="12" y2="15" />
    </symbol>
    <symbol id="ic-message" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
    </symbol>
    <symbol id="ic-bar-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <line x1="18" y1="20" x2="18" y2="10" />
      <line x1="12" y1="20" x2="12" y2="4" />
      <line x1="6" y1="20" x2="6" y2="14" />
    </symbol>
    <symbol id="ic-terminal" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <polyline points="4 17 10 11 4 5" />
      <line x1="12" y1="19" x2="20" y2="19" />
    </symbol>
    <symbol id="ic-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
      stroke-linecap="round" stroke-linejoin="round">
      <polyline points="20 6 9 17 4 12" />
    </symbol>
    <symbol id="ic-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
      stroke-linejoin="round">
      <line x1="18" y1="6" x2="6" y2="18" />
      <line x1="6" y1="6" x2="18" y2="18" />
    </symbol>
    <symbol id="ic-alert" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <circle cx="12" cy="12" r="10" />
      <line x1="12" y1="8" x2="12" y2="12" />
      <line x1="12" y1="16" x2="12.01" y2="16" />
    </symbol>
    <symbol id="ic-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <circle cx="12" cy="12" r="10" />
      <line x1="12" y1="16" x2="12" y2="12" />
      <line x1="12" y1="8" x2="12.01" y2="8" />
    </symbol>
    <symbol id="ic-logout" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
      <polyline points="16 17 21 12 16 7" />
      <line x1="21" y1="12" x2="9" y2="12" />
    </symbol>
    <symbol id="ic-refresh" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <polyline points="23 4 23 10 17 10" />
      <polyline points="1 20 1 14 7 14" />
      <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
    </symbol>
    <symbol id="ic-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
      <polyline points="7 10 12 15 17 10" />
      <line x1="12" y1="15" x2="12" y2="3" />
    </symbol>
    <symbol id="ic-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <circle cx="11" cy="11" r="8" />
      <line x1="21" y1="21" x2="16.65" y2="16.65" />
    </symbol>
    <symbol id="ic-reply" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <polyline points="9 17 4 12 9 7" />
      <path d="M20 18v-2a4 4 0 0 0-4-4H4" />
    </symbol>
    <symbol id="ic-shield" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
    </symbol>
    <symbol id="ic-wifi" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <path d="M1.42 9a16 16 0 0 1 21.16 0" />
      <path d="M5 12.55a11 11 0 0 1 14.08 0" />
      <path d="M8.53 16.11a6 6 0 0 1 6.95 0" />
      <line x1="12" y1="20" x2="12.01" y2="20" />
    </symbol>
    <symbol id="ic-wifi-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <line x1="1" y1="1" x2="23" y2="23" />
      <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55" />
      <path d="M5 12.55a11 11 0 0 1 5.17-2.39" />
      <path d="M10.71 5.05A16 16 0 0 1 22.56 9" />
      <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88" />
      <path d="M8.53 16.11a6 6 0 0 1 6.95 0" />
      <line x1="12" y1="20" x2="12.01" y2="20" />
    </symbol>
    <symbol id="ic-map-pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
      <circle cx="12" cy="10" r="3" />
    </symbol>
    <symbol id="ic-phone" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <path
        d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.72 12a19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 3.63 1h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.6a16 16 0 0 0 6.23 6.23l.96-.96a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z" />
    </symbol>
    <symbol id="ic-whatsapp" viewBox="0 0 24 24" fill="currentColor">
      <path
        d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413z" />
    </symbol>
    <symbol id="ic-mail" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
      <polyline points="22,6 12,13 2,6" />
    </symbol>
    <symbol id="ic-key" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <path
        d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />
    </symbol>
    <symbol id="ic-user" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
      <circle cx="12" cy="7" r="4" />
    </symbol>
    <symbol id="ic-lock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
      <path d="M7 11V7a5 5 0 0 1 10 0v4" />
    </symbol>
    <symbol id="ic-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
      <circle cx="12" cy="12" r="3" />
    </symbol>
    <symbol id="ic-building" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
      <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
    </symbol>
    <symbol id="ic-clipboard" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
      <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
    </symbol>
    <symbol id="ic-trending" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
      <polyline points="17 6 23 6 23 12" />
    </symbol>
    <symbol id="ic-git" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <circle cx="18" cy="18" r="3" />
      <circle cx="6" cy="6" r="3" />
      <path d="M13 6h3a2 2 0 0 1 2 2v7" />
      <line x1="6" y1="9" x2="6" y2="21" />
    </symbol>
    <symbol id="ic-filter" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
    </symbol>
  </svg>

  <style>
    :root {
      --c0: #0f1923;
      --c1: #1a2535;
      --c2: #1e2d42;
      --c3: #243350;
      --c4: #2d3f60;
      --br0: #243050;
      --br1: #2d3f62;
      --br2: #3d5282;
      --t0: #e8f0fe;
      --t1: #8fa3c8;
      --t2: #5a7096;
      --t3: #3a4f72;
      --cyan: #1eb8d0;
      --cyan2: #0e8fa4;
      --cyan-gl: rgba(30, 184, 208, 0.18);
      --blue: #2563c4;
      --blue2: #1a4fa0;
      --blue-gl: rgba(37, 99, 196, 0.2);
      --green: #22c97a;
      --green-gl: rgba(34, 201, 122, 0.18);
      --amber: #f59e3a;
      --amber-gl: rgba(245, 158, 58, 0.18);
      --red: #ef4565;
      --red-gl: rgba(239, 69, 101, 0.18);
      --purple: #7c5cbf;
      --font-hd: 'Bricolage Grotesque', -apple-system, sans-serif;
      --font-bd: 'DM Sans', -apple-system, sans-serif;
      --font-mn: 'JetBrains Mono', monospace;
      --r-sm: 6px;
      --r-md: 10px;
      --r-lg: 14px;
      --r-xl: 18px;
      --r-full: 9999px;
      --sh-sm: 0 1px 4px rgba(0, 0, 0, .35);
      --sh-md: 0 4px 16px rgba(0, 0, 0, .45);
      --sh-lg: 0 8px 32px rgba(0, 0, 0, .55);
      --tr: .18s cubic-bezier(.4, 0, .2, 1);
      --tr-s: .28s cubic-bezier(.4, 0, .2, 1);
    }

    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    html {
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased
    }

    body {
      font-family: var(--font-bd);
      background: var(--c0);
      color: var(--t0);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.6
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse 80% 60% at 15% 20%, rgba(30, 184, 208, .06) 0%, transparent 55%), radial-gradient(ellipse 60% 50% at 85% 75%, rgba(37, 99, 196, .07) 0%, transparent 55%);
      pointer-events: none;
      z-index: 0
    }

    svg.ic {
      display: inline-block;
      vertical-align: middle;
      flex-shrink: 0
    }

    /* ── LAYOUT ── */
    .wrap {
      max-width: 1420px;
      margin: 0 auto;
      padding: 24px;
      position: relative;
      z-index: 1
    }

    /* ── HEADER ── */
    .hdr {
      background: rgba(15, 25, 35, .88);
      backdrop-filter: blur(24px) saturate(160%);
      border-bottom: 1px solid var(--br0);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 200;
      box-shadow: 0 2px 12px rgba(0, 0, 0, .4)
    }

    .hdr-in {
      max-width: 1420px;
      margin: 0 auto;
      padding: 0 24px;
      height: 62px;
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 11px;
      font-family: var(--font-hd);
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: -.02em;
      cursor: default;
      user-select: none
    }

    .logo-ic {
      width: 38px;
      height: 38px;
      background: linear-gradient(135deg, var(--cyan), var(--blue));
      border-radius: var(--r-md);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 18px var(--cyan-gl), var(--sh-sm)
    }

    .hdr-r {
      display: flex;
      align-items: center;
      gap: 10px
    }

    #hdrUser {
      color: var(--t1);
      font-size: .8125rem;
      font-family: var(--font-mn);
      font-weight: 500;
      padding: 6px 12px;
      background: var(--c2);
      border: 1px solid var(--br0);
      border-radius: var(--r-md);
      transition: var(--tr)
    }

    #hdrUser:hover {
      color: var(--t0);
      border-color: var(--cyan);
      background: var(--c3)
    }

    /* ── CARDS ── */
    .card {
      background: var(--c1);
      border: 1px solid var(--br0);
      border-radius: var(--r-xl);
      padding: 22px;
      margin-bottom: 20px;
      transition: border-color var(--tr-s), box-shadow var(--tr-s);
      position: relative;
      overflow: hidden
    }

    .card:hover {
      border-color: var(--br1)
    }

    .card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(30, 184, 208, .3), transparent);
      opacity: 0;
      transition: opacity var(--tr-s)
    }

    .card:hover::after {
      opacity: 1
    }

    .ch {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      padding-bottom: 14px;
      border-bottom: 1px solid var(--br0)
    }

    .ct {
      font-family: var(--font-hd);
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: -.01em;
      display: flex;
      align-items: center;
      gap: 9px
    }

    .ct-ic {
      width: 30px;
      height: 30px;
      border-radius: var(--r-sm);
      display: flex;
      align-items: center;
      justify-content: center
    }

    .ct-ic.cyan {
      background: var(--cyan-gl);
      color: var(--cyan)
    }

    .ct-ic.blue {
      background: var(--blue-gl);
      color: var(--cyan)
    }

    .ct-ic.green {
      background: var(--green-gl);
      color: var(--green)
    }

    .ct-ic.amber {
      background: var(--amber-gl);
      color: var(--amber)
    }

    .ct-ic.red {
      background: var(--red-gl);
      color: var(--red)
    }

    .ct-ic.purple {
      background: rgba(124, 92, 191, .18);
      color: var(--purple)
    }

    /* ── TABS ── */
    .tabs {
      display: flex;
      gap: 4px;
      background: var(--c2);
      padding: 4px;
      border-radius: var(--r-lg);
      margin-bottom: 22px;
      border: 1px solid var(--br0)
    }

    .tab {
      flex: 1;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-radius: var(--r-md);
      color: var(--t2);
      font-weight: 600;
      font-size: .9rem;
      cursor: pointer;
      transition: all var(--tr-s);
      font-family: var(--font-hd);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px
    }

    .tab:hover:not(.on) {
      color: var(--t0);
      background: var(--c3)
    }

    .tab.on {
      background: linear-gradient(135deg, var(--cyan2), var(--blue2));
      color: #fff;
      box-shadow: 0 0 16px var(--cyan-gl), var(--sh-sm)
    }

    /* ── FORMS ── */
    .fg {
      margin-bottom: 16px
    }

    label {
      display: block;
      margin-bottom: 6px;
      color: var(--t1);
      font-size: .75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-family: var(--font-hd)
    }

    .inp-wrap {
      position: relative
    }

    .inp-ic {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--t2);
      pointer-events: none;
      transition: color var(--tr)
    }

    .inp-wrap input,
    .inp-wrap textarea,
    .inp-wrap select {
      padding-left: 40px
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 11px 14px;
      background: var(--c2);
      border: 1px solid var(--br0);
      border-radius: var(--r-md);
      color: var(--t0);
      font-size: .9375rem;
      font-family: var(--font-bd);
      transition: all var(--tr-s);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, .2)
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--t3)
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--cyan);
      background: var(--c3);
      box-shadow: 0 0 0 3px var(--cyan-gl), inset 0 1px 3px rgba(0, 0, 0, .2)
    }

    .inp-wrap input:focus~.inp-ic,
    .inp-wrap textarea:focus~.inp-ic,
    .inp-wrap select:focus+.inp-ic,
    .inp-wrap:focus-within .inp-ic {
      color: var(--cyan)
    }

    textarea {
      resize: vertical;
      min-height: 110px;
      line-height: 1.6;
      padding-top: 12px
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235a7096' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px
    }

    .pwd-wrap {
      position: relative
    }

    .pwd-wrap input {
      padding-right: 44px
    }

    .pwd-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--t2);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      width: auto;
      box-shadow: none;
      transition: color var(--tr)
    }

    .pwd-toggle:hover {
      color: var(--cyan)
    }

    /* ── BUTTONS ── */
    button {
      padding: 10px 18px;
      border: none;
      border-radius: var(--r-md);
      font-size: .9rem;
      font-weight: 600;
      font-family: var(--font-hd);
      cursor: pointer;
      transition: all var(--tr-s);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      box-shadow: var(--sh-sm)
    }

    .bp {
      background: linear-gradient(135deg, var(--cyan), var(--blue2));
      color: #fff;
      border: 1px solid transparent
    }

    .bp:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--sh-md), 0 0 18px var(--cyan-gl)
    }

    .bs {
      background: linear-gradient(135deg, var(--green), #1aa864);
      color: #fff;
      border: 1px solid transparent
    }

    .bs:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--sh-md), 0 0 18px var(--green-gl)
    }

    .bd {
      background: linear-gradient(135deg, var(--red), #d43060);
      color: #fff;
      border: 1px solid transparent
    }

    .bd:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--sh-md), 0 0 16px var(--red-gl)
    }

    .bg {
      background: var(--c2);
      color: var(--t0);
      border: 1px solid var(--br1)
    }

    .bg:hover:not(:disabled) {
      color: var(--cyan);
      border-color: var(--cyan);
      background: var(--c3);
      transform: translateY(-1px)
    }

    .bfull {
      width: 100%
    }

    .bsm {
      padding: 6px 13px;
      font-size: .8125rem
    }

    button:disabled {
      opacity: .4;
      cursor: not-allowed;
      transform: none !important
    }

    button:active:not(:disabled) {
      transform: translateY(0) !important
    }

    /* ── GRIDS ── */
    .g2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px
    }

    .g4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px
    }

    /* ── STAT CARDS ── */
    .sc {
      background: var(--c2);
      border: 1px solid var(--br0);
      padding: 20px;
      border-radius: var(--r-lg);
      transition: all var(--tr-s);
      position: relative;
      overflow: hidden
    }

    .sc-line {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      border-radius: 2px 2px 0 0
    }

    .sc:hover {
      border-color: var(--br2);
      transform: translateY(-2px);
      box-shadow: var(--sh-md)
    }

    .sl {
      font-size: .72rem;
      color: var(--t2);
      text-transform: uppercase;
      letter-spacing: .1em;
      margin-bottom: 8px;
      font-weight: 600;
      font-family: var(--font-hd);
      display: flex;
      align-items: center;
      gap: 6px
    }

    .sv {
      font-size: 2.1rem;
      font-weight: 800;
      font-family: var(--font-hd);
      background: linear-gradient(135deg, var(--cyan), #6bb8ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.1
    }

    /* ── BADGES ── */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--r-full);
      font-size: .75rem;
      font-weight: 600;
      font-family: var(--font-hd);
      border: 1px solid transparent
    }

    .b-on {
      background: rgba(34, 201, 122, .12);
      color: var(--green);
      border-color: rgba(34, 201, 122, .25)
    }

    .b-off {
      background: rgba(90, 112, 150, .1);
      color: var(--t2);
      border-color: var(--br0)
    }

    .bdot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: currentColor
    }

    .b-on .bdot {
      animation: pulse-dot 2s ease infinite;
      box-shadow: 0 0 6px currentColor
    }

    @keyframes pulse-dot {

      0%,
      100% {
        opacity: 1;
        transform: scale(1)
      }

      50% {
        opacity: .5;
        transform: scale(1.2)
      }
    }

    /* ── NOTIFICATION BELL ── */
    .nbell {
      position: relative;
      cursor: pointer;
      padding: 9px 11px;
      background: var(--c2);
      border: 1px solid var(--br0);
      border-radius: var(--r-md);
      transition: all var(--tr-s);
      color: var(--t1)
    }

    .nbell:hover {
      background: var(--c3);
      border-color: var(--cyan);
      color: var(--cyan);
      box-shadow: 0 0 14px var(--cyan-gl)
    }

    .nbadge {
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 19px;
      height: 19px;
      background: var(--red);
      border: 2px solid var(--c1);
      border-radius: var(--r-full);
      font-size: .65rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-family: var(--font-hd);
      box-shadow: 0 0 10px var(--red-gl);
      animation: badge-in .4s cubic-bezier(.68, -.55, .265, 1.55)
    }

    @keyframes badge-in {
      from {
        transform: scale(0)
      }

      to {
        transform: scale(1)
      }
    }

    /* ── NOTIFICATION PANEL ── */
    .npanel {
      position: fixed;
      top: 74px;
      right: 20px;
      width: 420px;
      max-height: calc(100vh - 100px);
      background: var(--c1);
      border: 1px solid var(--br1);
      border-radius: var(--r-xl);
      box-shadow: var(--sh-lg), 0 0 30px rgba(0, 0, 0, .4);
      overflow: hidden;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(20px)
    }

    .npanel:not(.hidden) {
      animation: panel-in .35s cubic-bezier(.4, 0, .2, 1)
    }

    @keyframes panel-in {
      from {
        opacity: 0;
        transform: translateY(-12px) scale(.97)
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1)
      }
    }

    .nphdr {
      padding: 14px 16px;
      border-bottom: 1px solid var(--br0);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      font-size: 1rem;
      font-family: var(--font-hd);
      background: var(--c2)
    }

    .nlist {
      flex: 1;
      overflow-y: auto;
      padding: 6px
    }

    .ni {
      padding: 12px;
      border-radius: var(--r-md);
      cursor: pointer;
      transition: background var(--tr);
      margin-bottom: 4px;
      border-left: 3px solid transparent
    }

    .ni:hover {
      background: var(--c2)
    }

    .ni.unread {
      background: rgba(30, 184, 208, .07);
      border-left-color: var(--cyan)
    }

    .ntime {
      font-size: .72rem;
      color: var(--t2);
      font-family: var(--font-mn);
      margin-bottom: 4px;
      font-weight: 500
    }

    .nmsg {
      font-size: .9rem;
      color: var(--t0);
      word-break: break-word;
      line-height: 1.5
    }

    .rbtn {
      margin-top: 8px;
      padding: 5px 12px;
      background: var(--c3);
      border: 1px solid var(--br1);
      color: var(--cyan);
      border-radius: var(--r-sm);
      font-size: .8rem;
      cursor: pointer;
      font-family: var(--font-hd);
      font-weight: 600;
      transition: all var(--tr);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      box-shadow: none
    }

    .rbtn:hover {
      background: var(--cyan);
      color: #fff;
      border-color: var(--cyan);
      transform: none
    }

    /* ── TOASTS ── */
    .tc {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 3000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 390px;
      pointer-events: none
    }

    .toast {
      background: var(--c1);
      border: 1px solid var(--br1);
      border-radius: var(--r-lg);
      padding: 14px 16px;
      box-shadow: var(--sh-lg);
      display: flex;
      gap: 12px;
      pointer-events: auto;
      animation: toast-in .32s cubic-bezier(.4, 0, .2, 1);
      border-left: 3px solid;
      transition: opacity .25s
    }

    .toast.audit {
      border-left-color: var(--cyan);
      box-shadow: var(--sh-lg), 0 0 20px var(--cyan-gl)
    }

    .toast.success {
      border-left-color: var(--green);
      box-shadow: var(--sh-lg), 0 0 20px var(--green-gl)
    }

    .toast.error {
      border-left-color: var(--red);
      box-shadow: var(--sh-lg), 0 0 20px var(--red-gl)
    }

    .toast.info {
      border-left-color: var(--t1)
    }

    @keyframes toast-in {
      from {
        transform: translateX(60px);
        opacity: 0
      }

      to {
        transform: translateX(0);
        opacity: 1
      }
    }

    .ticon {
      flex-shrink: 0;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center
    }

    .toast.audit .ticon {
      color: var(--cyan)
    }

    .toast.success .ticon {
      color: var(--green)
    }

    .toast.error .ticon {
      color: var(--red)
    }

    .toast.info .ticon {
      color: var(--t1)
    }

    .tbody {
      flex: 1
    }

    .ttitle {
      font-weight: 700;
      font-size: .9rem;
      margin-bottom: 2px;
      font-family: var(--font-hd)
    }

    .tmsg {
      font-size: .8125rem;
      color: var(--t1);
      line-height: 1.5
    }

    .tcls {
      background: none;
      border: none;
      color: var(--t2);
      cursor: pointer;
      flex-shrink: 0;
      width: auto;
      box-shadow: none;
      padding: 2px;
      border-radius: 4px;
      transition: color var(--tr)
    }

    .tcls:hover {
      color: var(--red);
      transform: none;
      box-shadow: none
    }

    /* ── LOG ── */
    .log {
      background: #07101a;
      border: 1px solid var(--br0);
      border-radius: var(--r-md);
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
      font-family: var(--font-mn);
      font-size: .78rem
    }

    .log:hover {
      border-color: var(--br1)
    }

    .lr {
      padding: 5px 4px;
      border-bottom: 1px solid rgba(255, 255, 255, .03);
      display: flex;
      gap: 10px;
      border-radius: 4px
    }

    .lr:hover {
      background: var(--c2);
      padding-left: 8px
    }

    .lt {
      color: var(--t3);
      flex-shrink: 0
    }

    .lm {
      color: var(--t1);
      line-height: 1.5
    }

    .l-success .lm {
      color: var(--green)
    }

    .l-error .lm {
      color: var(--red)
    }

    .l-warn .lm {
      color: var(--amber)
    }

    .l-info .lm {
      color: var(--cyan)
    }

    /* ── SEARCH DROP ── */
    .swrap {
      position: relative
    }

    /* DROPDOWN FIX - Z-INDEX AND POINTER EVENTS */
    .sdrop {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      background: var(--c3);
      border: 1px solid var(--br1);
      border-radius: var(--r-md);
      max-height: 260px;
      overflow-y: auto;
      z-index: 1000;
      /* INCREASED FROM 100 */
      box-shadow: var(--sh-lg);
      animation: drop-in .2s var(--tr);
      pointer-events: auto;
      /* EXPLICITLY SET */
    }

    @keyframes drop-in {
      from {
        opacity: 0;
        transform: translateY(-8px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .sitem {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--br0);
      transition: background var(--tr);
      pointer-events: auto;
      /* CRITICAL FIX */
      user-select: none;
      /* PREVENT TEXT SELECTION INTERFERING WITH CLICK */
    }

    .sitem:hover {
      background: var(--c4)
    }

    .sitem:last-child {
      border-bottom: none
    }

    /* ── USER TABLE ── */
    .utbl {
      width: 100%;
      border-collapse: collapse
    }

    .utbl th {
      padding: 10px 12px;
      text-align: left;
      font-size: .72rem;
      color: var(--t2);
      text-transform: uppercase;
      letter-spacing: .1em;
      font-weight: 700;
      font-family: var(--font-hd);
      background: var(--c0);
      border-bottom: 1px solid var(--br1);
      position: sticky;
      top: 0;
      z-index: 10
    }

    .utbl td {
      padding: 11px 12px;
      border-bottom: 1px solid var(--br0);
      font-size: .875rem;
      color: var(--t1);
      transition: all var(--tr)
    }

    .utbl tr:hover td {
      background: var(--c2);
      color: var(--t0)
    }

    .uav {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--cyan2), var(--blue2));
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: .8125rem;
      font-family: var(--font-hd);
      flex-shrink: 0
    }

    /* ── FILE UPLOAD ── */
    .fil {
      display: none
    }

    .flab {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 11px 20px;
      background: linear-gradient(135deg, var(--cyan), var(--blue2));
      color: #fff;
      border-radius: var(--r-md);
      cursor: pointer;
      font-weight: 600;
      font-size: .9rem;
      font-family: var(--font-hd);
      transition: all var(--tr-s);
      box-shadow: var(--sh-sm)
    }

    .flab:hover {
      transform: translateY(-2px);
      box-shadow: var(--sh-md), 0 0 18px var(--cyan-gl)
    }

    /* ── MODAL ── */
    .mover {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .75);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2001;
      padding: 20px;
      animation: overlay-in .2s ease
    }

    @keyframes overlay-in {
      from {
        opacity: 0
      }

      to {
        opacity: 1
      }
    }

    .modal {
      background: var(--c1);
      border: 1px solid var(--br1);
      border-radius: var(--r-xl);
      padding: 26px;
      width: 100%;
      max-width: 500px;
      box-shadow: var(--sh-lg);
      animation: modal-in .3s cubic-bezier(.34, 1.56, .64, 1);
      max-height: 90vh;
      overflow-y: auto
    }

    @keyframes modal-in {
      from {
        opacity: 0;
        transform: scale(.93) translateY(20px)
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0)
      }
    }

    .mtitle {
      font-size: 1.2rem;
      font-weight: 700;
      font-family: var(--font-hd);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .origmsg {
      background: var(--c2);
      border-left: 3px solid var(--cyan);
      border-radius: var(--r-md);
      padding: 12px;
      margin-bottom: 16px;
      font-size: .875rem;
      color: var(--t1);
      line-height: 1.6
    }

    /* ── CHIPS ── */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 5px 12px;
      background: var(--c2);
      border: 1px solid var(--br0);
      border-radius: var(--r-full);
      font-size: .8125rem;
      font-family: var(--font-mn);
      font-weight: 500;
      transition: all var(--tr)
    }

    .chip:hover {
      border-color: var(--cyan);
      background: var(--c3);
      transform: translateY(-1px)
    }

    /* ── UNREGISTERED USER CARD ── */
    .unreg-card {
      background: var(--c2);
      border: 1px solid var(--br0);
      border-radius: var(--r-lg);
      padding: 14px 16px;
      margin-bottom: 10px;
      transition: border-color var(--tr)
    }

    .unreg-card:hover {
      border-color: var(--br2)
    }

    .unreg-name {
      font-weight: 600;
      color: var(--t0);
      font-family: var(--font-hd);
      font-size: .9375rem;
      margin-bottom: 6px
    }

    .unreg-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px
    }

    .unreg-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 10px;
      border-radius: var(--r-full);
      font-size: .75rem;
      font-weight: 500;
      font-family: var(--font-hd)
    }

    .pill-floor {
      background: rgba(37, 99, 196, .15);
      color: #6bb8ff;
      border: 1px solid rgba(37, 99, 196, .3)
    }

    .pill-phone {
      background: rgba(34, 201, 122, .12);
      color: var(--green);
      border: 1px solid rgba(34, 201, 122, .25)
    }

    .pill-wa {
      background: rgba(37, 211, 102, .12);
      color: #25d366;
      border: 1px solid rgba(37, 211, 102, .25)
    }

    .wa-btn {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 8px 16px;
      background: #25d366;
      color: #fff;
      border: none;
      border-radius: var(--r-md);
      font-size: .8125rem;
      font-weight: 600;
      font-family: var(--font-hd);
      cursor: pointer;
      transition: all var(--tr-s);
      box-shadow: var(--sh-sm);
      text-decoration: none
    }

    .wa-btn:hover {
      background: #1aa851;
      transform: translateY(-1px);
      box-shadow: var(--sh-md), 0 0 14px rgba(37, 211, 102, .3)
    }

    /* ── IMPORT RESULTS ── */
    .import-results {
      margin-top: 16px
    }

    .import-tabs {
      display: flex;
      gap: 4px;
      background: var(--c2);
      padding: 3px;
      border-radius: var(--r-md);
      margin-bottom: 12px;
      border: 1px solid var(--br0)
    }

    .import-tab {
      flex: 1;
      padding: 7px;
      background: transparent;
      border: none;
      border-radius: var(--r-sm);
      color: var(--t2);
      font-size: .8rem;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--font-hd);
      transition: all var(--tr);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px
    }

    .import-tab.active {
      background: var(--c3);
      color: var(--t0);
      border: 1px solid var(--br1)
    }

    /* ── PERMISSION BANNER ── */
    #permBanner {
      display: none;
      background: rgba(245, 158, 58, .08);
      border: 1px solid rgba(245, 158, 58, .3);
      border-left: 3px solid var(--amber);
      padding: 12px 16px;
      border-radius: var(--r-lg);
      margin-bottom: 20px;
      align-items: center;
      justify-content: space-between;
      gap: 12px
    }

    /* ── DIVIDER ── */
    .divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 16px 0;
      color: var(--t3);
      font-size: .75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--br0)
    }

    /* ── SCROLLBAR ── */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px
    }

    ::-webkit-scrollbar-track {
      background: var(--c2);
      border-radius: 3px
    }

    ::-webkit-scrollbar-thumb {
      background: var(--br2);
      border-radius: 3px
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--cyan2)
    }

    /* ── UTIL ── */
    .hidden {
      display: none !important
    }

    ::selection {
      background: var(--cyan-gl);
      color: var(--t0)
    }

    *:focus-visible {
      outline: 2px solid var(--cyan);
      outline-offset: 2px;
      border-radius: 4px
    }

    @media(prefers-reduced-motion:reduce) {

      *,
      *::before,
      *::after {
        animation-duration: .01ms !important;
        transition-duration: .01ms !important
      }
    }

    @media(max-width:900px) {

      .g2,
      .g4 {
        grid-template-columns: 1fr
      }

      .wrap {
        padding: 14px
      }
    }

    @media(max-width:600px) {
      #hdrUser {
        display: none
      }

      .npanel {
        width: calc(100% - 28px);
        right: 14px
      }

      .tc {
        right: 14px;
        left: 14px;
        max-width: none
      }
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <div class="hdr">
    <div class="hdr-in">
      <div class="logo">
        <div class="logo-ic">
          <svg class="ic" width="20" height="20">
            <use href="#ic-shield" />
          </svg>
        </div>
        <span>Audit Notification System</span>
      </div>
      <div class="hdr-r" id="hdrR" style="display:none">
        <span id="hdrUser"></span>
        <div class="nbell" onclick="togglePanel()" title="Notifications">
          <svg class="ic" width="18" height="18">
            <use href="#ic-bell" />
          </svg>
          <span class="nbadge hidden" id="nbadge">0</span>
        </div>
        <button class="bg bsm" onclick="logout()" title="Logout">
          <svg class="ic" width="15" height="15">
            <use href="#ic-logout" />
          </svg> Logout
        </button>
      </div>
    </div>
  </div>

  <!-- NOTIFICATION PANEL -->
  <div class="npanel hidden" id="npanel">
    <div class="nphdr">
      <span>Notifications</span>
      <button class="bg bsm" onclick="clearNotifs()">
        <svg class="ic" width="13" height="13">
          <use href="#ic-x" />
        </svg> Clear All
      </button>
    </div>
    <div class="nlist" id="nlist">
      <div style="padding:40px;text-align:center;color:var(--t2)">No notifications yet</div>
    </div>
  </div>

  <!-- TOASTS -->
  <div class="tc" id="tc"></div>

  <div class="wrap">

    <!-- AUTH SECTION -->
    <div id="authSec">
      <div class="card" style="max-width:460px;margin:70px auto">
        <div style="text-align:center;margin-bottom:22px">
          <div
            style="width:56px;height:56px;background:linear-gradient(135deg,var(--cyan),var(--blue2));border-radius:14px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;box-shadow:0 0 24px var(--cyan-gl)">
            <svg class="ic" width="26" height="26" style="color:#fff">
              <use href="#ic-shield" />
            </svg>
          </div>
          <div style="font-family:var(--font-hd);font-size:1.4rem;font-weight:700;letter-spacing:-.02em">Nexus Audit
          </div>
          <div style="color:var(--t2);font-size:.875rem;margin-top:4px">Real-Time Compliance Platform</div>
        </div>
        <div class="tabs">
          <button class="tab on" onclick="swTab('login',this)">
            <svg class="ic" width="15" height="15">
              <use href="#ic-lock" />
            </svg> Login
          </button>
          <button class="tab" onclick="swTab('reg',this)">
            <svg class="ic" width="15" height="15">
              <use href="#ic-user" />
            </svg> Register
          </button>
        </div>
        <!-- LOGIN -->
        <div id="loginTab">
          <div class="fg">
            <label>Gitea Username</label>
            <div class="inp-wrap">
              <input id="lu" type="text" placeholder="your gitea username" autocomplete="username">
              <svg class="ic inp-ic" width="16" height="16">
                <use href="#ic-git" />
              </svg>
            </div>
          </div>
          <div class="fg">
            <label>Password</label>
            <div class="inp-wrap pwd-wrap">
              <input id="lp" type="password" placeholder="Enter password" autocomplete="current-password"
                style="padding-left:40px">
              <svg class="ic inp-ic" width="16" height="16">
                <use href="#ic-lock" />
              </svg>
              <button type="button" class="pwd-toggle" onclick="togglePwd('lp',this)" title="Show password">
                <svg class="ic" width="16" height="16">
                  <use href="#ic-eye" />
                </svg>
              </button>
            </div>
          </div>
          <button class="bp bfull" onclick="login()" style="margin-bottom:12px">
            <svg class="ic" width="16" height="16">
              <use href="#ic-lock" />
            </svg> Sign In
          </button>
          <!-- REPLACE THE EXISTING FORGOT PASSWORD BUTTON WITH THIS -->
          <div class="divider">or</div>
          <div style="display:flex;gap:10px">
            <button class="bg bfull" onclick="showPasscodeReset()" style="font-size:.8125rem">
              <svg class="ic" width="14" height="14">
                <use href="#ic-key" />
              </svg> Reset via Passcode
            </button>
          </div>
        </div>
        <!-- REGISTER -->
        <div id="regTab" class="hidden">
          <div class="fg">
            <label>Full Name</label>
            <div class="inp-wrap">
              <input id="rn" type="text" placeholder="Oh Snap">
              <svg class="ic inp-ic" width="16" height="16">
                <use href="#ic-user" />
              </svg>
            </div>
          </div>
          <div class="fg">
            <label>Gitea Username</label>
            <div class="inp-wrap">
              <input id="ru" type="text" placeholder="your gitea username" autocomplete="username">
              <svg class="ic inp-ic" width="16" height="16">
                <use href="#ic-git" />
              </svg>
            </div>
          </div>
          <div class="fg">
            <label>Email Address</label>
            <div class="inp-wrap">
              <input id="re" type="email" placeholder="you@email.com" autocomplete="email">
              <svg class="ic inp-ic" width="16" height="16">
                <use href="#ic-mail" />
              </svg>
            </div>
          </div>
          <!-- ADD THIS AFTER EMAIL FIELD IN REGISTER TAB -->
          <div class="fg">
            <label>Recovery Passcode</label>
            <div class="inp-wrap">
              <input id="rpc" type="password" placeholder="6 digits" maxlength="6" pattern="[0-9]{6}"
                inputmode="numeric" autocomplete="off"
                style="padding-left:40px;font-family:var(--font-mn);letter-spacing:2px">
              <svg class="ic inp-ic" width="16" height="16">
                <use href="#ic-key" />
              </svg>
            </div>
            <div style="font-size:.75rem;color:var(--t2);margin-top:4px">
              Set a 6-digit code to reset your password incase you get locked out.
              <br>
              <strong style="color:var(--amber)">Use Digits you can rememeber</strong>
            </div>
          </div>
          <div class="fg">
            <label>Password</label>
            <div class="inp-wrap pwd-wrap">
              <input id="rp" type="password" placeholder="Min 6 characters" autocomplete="new-password"
                style="padding-left:40px">
              <svg class="ic inp-ic" width="16" height="16">
                <use href="#ic-lock" />
              </svg>
              <button type="button" class="pwd-toggle" onclick="togglePwd('rp',this)">
                <svg class="ic" width="16" height="16">
                  <use href="#ic-eye" />
                </svg>
              </button>
            </div>
          </div>
          <button class="bs bfull" onclick="register()">
            <svg class="ic" width="16" height="16">
              <use href="#ic-check" />
            </svg> Create Account
          </button>
        </div>
      </div>
    </div>

    <!-- MAIN APP -->
    <div id="appSec" class="hidden">

      <!-- Permission Banner -->
      <div id="permBanner">
        <div style="display:flex;align-items:center;gap:10px;font-size:.875rem">
          <svg class="ic" width="18" height="18" style="color:var(--amber)">
            <use href="#ic-bell" />
          </svg>
          Enable desktop notifications to receive instant audit alerts
        </div>
        <button class="bp bsm" onclick="reqPerm()">
          <svg class="ic" width="14" height="14">
            <use href="#ic-check" />
          </svg> Enable
        </button>
      </div>

      <!-- STATS ROW -->
      <div class="g4" style="margin-bottom:20px">
        <div class="sc">
          <div class="sc-line" style="background:linear-gradient(90deg,var(--cyan),var(--blue))"></div>
          <div class="sl"><svg class="ic" width="13" height="13">
              <use href="#ic-wifi" />
            </svg> Online</div>
          <div class="sv" id="sOn">0</div>
        </div>
        <div class="sc">
          <div class="sc-line" style="background:linear-gradient(90deg,var(--blue),var(--purple))"></div>
          <div class="sl"><svg class="ic" width="13" height="13">
              <use href="#ic-users" />
            </svg> Total Users</div>
          <div class="sv" id="sTot">0</div>
        </div>
        <div class="sc">
          <div class="sc-line" style="background:linear-gradient(90deg,var(--green),var(--cyan))"></div>
          <div class="sl"><svg class="ic" width="13" height="13">
              <use href="#ic-send" />
            </svg> Audits Sent</div>
          <div class="sv" id="sAud">0</div>
        </div>
        <div class="sc" id="scFb" style="display:none">
          <div class="sc-line" style="background:linear-gradient(90deg,var(--amber),var(--red))"></div>
          <div class="sl"><svg class="ic" width="13" height="13">
              <use href="#ic-clipboard" />
            </svg> Pending Feedback</div>
          <div class="sv" id="sFb">0</div>
        </div>
      </div>

      <!-- CONNECTION + ONLINE USERS -->
      <div class="g2">
        <div class="card">
          <div class="ch">
            <div class="ct">
              <div class="ct-ic cyan"><svg class="ic" width="16" height="16">
                  <use href="#ic-wifi" />
                </svg></div>
              Connection
            </div>
            <span class="badge b-off" id="cbadge"><span class="bdot"></span><span id="ctext">Offline</span></span>
          </div>
          <button id="cbtn" class="bp bfull" onclick="connectWS()">
            <svg class="ic" width="16" height="16">
              <use href="#ic-wifi" />
            </svg> Connect
          </button>
        </div>
        <div class="card">
          <div class="ch">
            <div class="ct">
              <div class="ct-ic blue"><svg class="ic" width="16" height="16">
                  <use href="#ic-users" />
                </svg></div>
              Online Now
            </div>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;min-height:32px" id="chips">
            <span style="color:var(--t2);font-size:.875rem">No users online</span>
          </div>
        </div>
      </div>

      <!-- SEND AUDIT -->
      <div id="auditCard" class="card hidden">
        <div class="ch">
          <div class="ct">
            <div class="ct-ic cyan"><svg class="ic" width="16" height="16">
                <use href="#ic-send" />
              </svg></div>
            Send Audit Request
          </div>
        </div>
        <div class="g2">
          <div class="fg swrap">
            <label>Target User</label>
            <div class="inp-wrap">
              <input id="tUser" type="text" placeholder="Search by gitea username or name…" autocomplete="off"
                oninput="srchUsers(this.value)" onfocus="srchUsers(this.value)" style="padding-left:40px">
              <svg class="ic inp-ic" width="16" height="16">
                <use href="#ic-search" />
              </svg>
            </div>
            <div id="sdrop" class="sdrop hidden"></div>
          </div>
          <div class="fg">
            <label>Audit Details</label>
            <div class="inp-wrap">
              <input id="aDetail" type="text" placeholder="Describe what needs auditing…" style="padding-left:40px">
              <svg class="ic inp-ic" width="16" height="16">
                <use href="#ic-clipboard" />
              </svg>
            </div>
          </div>
        </div>
        <button class="bs bfull" onclick="sendAudit()">
          <svg class="ic" width="16" height="16">
            <use href="#ic-send" />
          </svg> Send Audit Request
        </button>
      </div>

      <!-- FEEDBACK FORM (non-admin) -->
      <div id="fbForm" class="card">
        <div class="ch">
          <div class="ct">
            <div class="ct-ic purple"><svg class="ic" width="16" height="16">
                <use href="#ic-message" />
              </svg></div>
            Send Feedback
          </div>
        </div>
        <div class="g2">
          <div class="fg">
            <label>Type</label>
            <div class="inp-wrap">
              <select id="fbT" style="padding-left:40px">
                <option value="bug">Bug Report</option>
                <option value="feature">Feature Request</option>
                <option value="general">General Feedback</option>
              </select>
              <svg class="ic inp-ic" width="16" height="16">
                <use href="#ic-filter" />
              </svg>
            </div>
          </div>
          <div class="fg">
            <label>Subject</label>
            <div class="inp-wrap">
              <input id="fbS" type="text" placeholder="Brief description…" style="padding-left:40px">
              <svg class="ic inp-ic" width="16" height="16">
                <use href="#ic-clipboard" />
              </svg>
            </div>
          </div>
        </div>
        <div class="fg">
          <label>Message</label>
          <textarea id="fbM" placeholder="Describe your feedback in detail…"></textarea>
        </div>
        <button class="bs bfull" onclick="submitFb()">
          <svg class="ic" width="16" height="16">
            <use href="#ic-send" />
          </svg> Submit Feedback
        </button>
      </div>

      <!-- ===== ADMIN ONLY ===== -->

      <!-- IMPORT USERS -->
      <div id="importCard" class="card hidden">
        <div class="ch">
          <div class="ct">
            <div class="ct-ic cyan"><svg class="ic" width="16" height="16">
                <use href="#ic-upload" />
              </svg></div>
            Import Users from Excel
          </div>
        </div>
        <div
          style="background:var(--c2);border:1px solid var(--br0);border-radius:var(--r-md);padding:14px 16px;margin-bottom:16px;font-size:.875rem;color:var(--t1);line-height:1.7">
          <strong style="color:var(--t0);display:block;margin-bottom:6px">Expected Excel Columns:</strong>
          <div style="display:flex;flex-wrap:wrap;gap:8px">
            <span
              style="background:var(--c3);border:1px solid var(--br1);padding:2px 10px;border-radius:4px;font-family:var(--font-mn);font-size:.78rem">A:
              First Name</span>
            <span
              style="background:var(--c3);border:1px solid var(--br1);padding:2px 10px;border-radius:4px;font-family:var(--font-mn);font-size:.78rem">B:
              Last Name</span>
            <span
              style="background:var(--c3);border:1px solid var(--br1);padding:2px 10px;border-radius:4px;font-family:var(--font-mn);font-size:.78rem">C:
              Gitea Username</span>
            <span
              style="background:rgba(37,99,196,.15);border:1px solid rgba(37,99,196,.3);padding:2px 10px;border-radius:4px;font-family:var(--font-mn);font-size:.78rem;color:#6bb8ff">D:
              Phone (optional)</span>
            <span
              style="background:rgba(37,99,196,.15);border:1px solid rgba(37,99,196,.3);padding:2px 10px;border-radius:4px;font-family:var(--font-mn);font-size:.78rem;color:#6bb8ff">E:
              Floor (optional)</span>
          </div>
          <div style="margin-top:8px;color:var(--t2);font-size:.8rem">Users without a Gitea account will appear as
            <strong style="color:var(--amber)">Unregistered</strong> — with WhatsApp invite option and floor location.
          </div>
        </div>
        <div style="text-align:center;padding:10px">
          <input type="file" id="xlFile" class="fil" accept=".xlsx,.xls" onchange="importUsers()">
          <label for="xlFile" class="flab">
            <svg class="ic" width="17" height="17">
              <use href="#ic-upload" />
            </svg> Choose Excel File
          </label>
          <div id="impSt" style="margin-top:12px;font-size:.875rem"></div>
        </div>
        <div id="importResults" class="import-results hidden"></div>
      </div>

      <!-- BROADCAST -->
      <div id="bcCard" class="card hidden">
        <div class="ch">
          <div class="ct">
            <div class="ct-ic amber"><svg class="ic" width="16" height="16">
                <use href="#ic-radio" />
              </svg></div>
            Broadcast Message
          </div>
        </div>
        <div class="g2">
          <div class="fg">
            <label>Target Audience</label>
            <div class="inp-wrap">
              <select id="bcTarget" style="padding-left:40px">
                <option value="online">Online Users Only</option>
                <option value="all">All Registered Users</option>
              </select>
              <svg class="ic inp-ic" width="16" height="16">
                <use href="#ic-users" />
              </svg>
            </div>
          </div>
          <div class="fg">
            <label>Message</label>
            <div class="inp-wrap">
              <input id="bcMsg" type="text" placeholder="Type your announcement…" style="padding-left:40px">
              <svg class="ic inp-ic" width="16" height="16">
                <use href="#ic-radio" />
              </svg>
            </div>
          </div>
        </div>
        <button class="bp bfull" onclick="sendBroadcast()">
          <svg class="ic" width="16" height="16">
            <use href="#ic-radio" />
          </svg> Send Broadcast
        </button>
      </div>

      <!-- USER MANAGEMENT -->
      <div id="userCard" class="card hidden">
        <div class="ch">
          <div class="ct">
            <div class="ct-ic blue"><svg class="ic" width="16" height="16">
                <use href="#ic-users" />
              </svg></div>
            User Management
          </div>
          <div style="display:flex;gap:8px">
            <button class="bg bsm" onclick="loadUsers()">
              <svg class="ic" width="13" height="13">
                <use href="#ic-refresh" />
              </svg> Refresh
            </button>
            <button class="bs bsm" onclick="exportCSV()">
              <svg class="ic" width="13" height="13">
                <use href="#ic-download" />
              </svg> Export CSV
            </button>
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-bottom:12px">
          <div class="inp-wrap" style="flex:1">
            <input id="uSrch" type="text" placeholder="Search by name, username or email…"
              oninput="filterUsers(this.value)" style="padding-left:40px">
            <svg class="ic inp-ic" width="16" height="16">
              <use href="#ic-search" />
            </svg>
          </div>
          <div class="inp-wrap" style="width:155px">
            <select id="uFilter" onchange="filterUsers()" style="padding-left:36px">
              <option value="all">All Users</option>
              <option value="online">Online Only</option>
              <option value="offline">Offline Only</option>
            </select>
            <svg class="ic inp-ic" width="14" height="14">
              <use href="#ic-filter" />
            </svg>
          </div>
        </div>
        <div
          style="display:flex;gap:24px;background:var(--c2);padding:10px 16px;border-radius:var(--r-md);margin-bottom:14px;border:1px solid var(--br0)">
          <span style="font-size:.8125rem;color:var(--t1);display:flex;align-items:center;gap:6px">
            <svg class="ic" width="13" height="13" style="color:var(--t2)">
              <use href="#ic-users" />
            </svg>
            Total: <strong id="uTot" style="color:var(--t0)">0</strong>
          </span>
          <span style="font-size:.8125rem;color:var(--t1);display:flex;align-items:center;gap:6px">
            <span style="width:7px;height:7px;border-radius:50%;background:var(--green);display:inline-block"></span>
            Online: <strong id="uOn" style="color:var(--green)">0</strong>
          </span>
          <span style="font-size:.8125rem;color:var(--t1);display:flex;align-items:center;gap:6px">
            <svg class="ic" width="13" height="13" style="color:var(--cyan)">
              <use href="#ic-trending" />
            </svg>
            New Today: <strong id="uNew" style="color:var(--cyan)">0</strong>
          </span>
        </div>
        <div style="max-height:480px;overflow-y:auto;border:1px solid var(--br0);border-radius:var(--r-md)">
          <table class="utbl">
            <thead>
              <tr>
                <th>User</th>
                <th>Email</th>
                <th>Status</th>
                <th>Joined</th>
                <th>Last Login</th>
                <th style="text-align:center">Actions</th>
              </tr>
            </thead>
            <tbody id="uBody">
              <tr>
                <td colspan="6" style="text-align:center;padding:40px;color:var(--t2)">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- FEEDBACK MANAGEMENT -->
      <div id="fbMgmt" class="card hidden">
        <div class="ch">
          <div class="ct">
            <div class="ct-ic purple"><svg class="ic" width="16" height="16">
                <use href="#ic-message" />
              </svg></div>
            Feedback Management
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="inp-wrap" style="width:auto">
              <select id="fbFilt" onchange="loadFeedback()" style="padding:7px 30px 7px 34px;font-size:.8rem">
                <option value="all">All Types</option>
                <option value="bug">Bugs</option>
                <option value="feature">Features</option>
                <option value="general">General</option>
              </select>
              <svg class="ic inp-ic" width="13" height="13">
                <use href="#ic-filter" />
              </svg>
            </div>
            <button class="bg bsm" onclick="loadFeedback()">
              <svg class="ic" width="13" height="13">
                <use href="#ic-refresh" />
              </svg> Refresh
            </button>
          </div>
        </div>
        <div id="fbList" style="max-height:420px;overflow-y:auto"></div>
      </div>

      <!-- SYSTEM ANALYTICS -->
      <div id="statsCard" class="card hidden">
        <div class="ch">
          <div class="ct">
            <div class="ct-ic green"><svg class="ic" width="16" height="16">
                <use href="#ic-trending" />
              </svg></div>
            System Analytics
          </div>
          <button class="bg bsm" onclick="loadStats()">
            <svg class="ic" width="13" height="13">
              <use href="#ic-refresh" />
            </svg> Refresh
          </button>
        </div>
        <div class="g4">
          <div class="sc">
            <div class="sc-line" style="background:linear-gradient(90deg,var(--cyan),var(--blue))"></div>
            <div class="sl"><svg class="ic" width="12" height="12">
                <use href="#ic-users" />
              </svg> Total Users</div>
            <div class="sv" id="stU">0</div>
          </div>
          <div class="sc">
            <div class="sc-line" style="background:linear-gradient(90deg,var(--green),var(--cyan))"></div>
            <div class="sl"><svg class="ic" width="12" height="12">
                <use href="#ic-wifi" />
              </svg> Online Now</div>
            <div class="sv" id="stO">0</div>
          </div>
          <div class="sc">
            <div class="sc-line" style="background:linear-gradient(90deg,var(--blue),var(--purple))"></div>
            <div class="sl"><svg class="ic" width="12" height="12">
                <use href="#ic-send" />
              </svg> Total Audits</div>
            <div class="sv" id="stA">0</div>
          </div>
          <div class="sc">
            <div class="sc-line" style="background:linear-gradient(90deg,var(--amber),var(--red))"></div>
            <div class="sl"><svg class="ic" width="12" height="12">
                <use href="#ic-clipboard" />
              </svg> Pending Feedback</div>
            <div class="sv" id="stF">0</div>
          </div>
        </div>
      </div>

      <!-- ACTIVITY LOG -->
      <div class="card">
        <div class="ch">
          <div class="ct">
            <div class="ct-ic amber"><svg class="ic" width="16" height="16">
                <use href="#ic-terminal" />
              </svg></div>
            Activity Log
          </div>
          <button class="bg bsm" onclick="document.getElementById('logBox').innerHTML=''">
            <svg class="ic" width="13" height="13">
              <use href="#ic-x" />
            </svg> Clear
          </button>
        </div>
        <div class="log" id="logBox">
          <div class="lr l-info"><span class="lt">[SYSTEM]</span><span class="lm">Nexus Audit ready</span></div>
        </div>
      </div>

    </div><!-- /appSec -->
  </div><!-- /wrap -->

  <script>
    // ── config ────────────────────────────────────────────────────
    const API = location.hostname === 'localhost' ? 'http://localhost:8080' : 'https://audit-notification.onrender.com';
    const WSS = location.hostname === 'localhost' ? 'ws://localhost:8080' : 'wss://audit-notification.onrender.com';

    // ── sounds ────────────────────────────────────────────────────
    const SND = {
      audit: new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3'),
      reply: new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'),
      success: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'),
    };
    Object.values(SND).forEach(function (a) { a.volume = 1.0; });
    function playSound(t) { var s = SND[t] || SND.audit; s.currentTime = 0; s.play().catch(function () { }); }

    // ── state ─────────────────────────────────────────────────────
    var ws = null, me = null, manualDisc = false, retries = 0;
    var notifs = [], unread = 0, online = [], auditCount = 0;
    var userList = [], onlineTimer = null, srchTimer = null;

    // NOTIFICATION SYNC (NEW - FIX FOR ISSUE #1)
    // Intelligent polling with Page Visibility API
    // ══════════════════════════════════════════════════════════════
    var syncTimer = null;
    var lastSync = 0;
    var syncInterval = 30000; // 30 seconds
    var isTabVisible = true;

    // Page Visibility API integration
    document.addEventListener('visibilitychange', function () {
      isTabVisible = !document.hidden;

      if (isTabVisible && me) {
        // Tab became visible — sync immediately
        addLog('Tab visible — syncing notifications', 'info');
        syncNotifications();
      }

      // Adjust sync frequency based on visibility
      if (isTabVisible) {
        startNotificationSync();
      } else {
        // Tab hidden — reduce frequency to save resources
        clearInterval(syncTimer);
      }
    });

    function startNotificationSync() {
      if (!me) return;

      clearInterval(syncTimer);

      // Immediate sync on start
      syncNotifications();

      // Periodic sync while tab is visible
      syncTimer = setInterval(function () {
        if (isTabVisible && me) {
          syncNotifications();
        }
      }, syncInterval);
    }

    async function syncNotifications() {
      if (!me) return;

      var now = Date.now();
      // Throttle: don't sync more than once every 5 seconds
      if (now - lastSync < 5000) return;
      lastSync = now;

      try {
        var r = await fetch(API + '/sync-notifications?user=' + me.username, {
          cache: 'no-cache',
          headers: { 'Cache-Control': 'no-cache' }
        });

        if (!r.ok) return;

        var data = await r.json();
        var notifications = data.notifications || [];

        if (notifications.length > 0) {
          addLog('Synced ' + notifications.length + ' missed notifications', 'success');

          notifications.forEach(function (n) {
            playSound(n.replyTo ? 'reply' : 'audit');
            var title = n.replyTo ? ('Reply from @' + n.sender) : ('Audit from @' + n.sender);
            toast(title, n.message, n.replyTo ? 'success' : 'audit', 8000);
            deskNotif(n.sender, n.message);

            addNotif({
              id: n.id,
              message: n.message,
              sender: n.sender,
              time: new Date(n.timestamp),
              read: false,
              canReply: !n.replyTo,
              isReply: !!n.replyTo
            });
          });

          // Mark them as delivered on backend
          markNotificationsDelivered(notifications.map(function (n) { return n.id; }));
        }
      } catch (err) {
        console.error('Sync error:', err);
      }
    }

    async function markNotificationsDelivered(ids) {
      if (!ids || !ids.length) return;
      try {
        await fetch(API + '/mark-delivered', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: ids, user: me.username })
        });
      } catch (err) { }
    }

    // ── password toggle ───────────────────────────────────────────
    function togglePwd(id, btn) {
      var inp = document.getElementById(id);
      inp.type = inp.type === 'password' ? 'text' : 'password';
    }


    // ── PASSCODE RESET FLOW (NEW) ─────────────────────────────────
    function showPasscodeReset() {
      openModal(
        '<svg class="ic" width="18" height="18"><use href="#ic-key"/></svg> Reset via Recovery Passcode',
        '<div style="background:rgba(30,184,208,.08);border:1px solid rgba(30,184,208,.3);border-radius:10px;padding:12px;margin-bottom:16px;font-size:.85rem;color:var(--t1);line-height:1.6">' +
        '<svg class="ic" width="14" height="14" style="color:var(--cyan);vertical-align:middle;margin-right:6px"><use href="#ic-info"/></svg>' +
        'Use the 6-digit recovery passcode you created during registration.' +
        '</div>' +
        '<div class="fg"><label>Gitea Username</label><div class="inp-wrap"><input id="pcUsername" type="text" placeholder="your-gitea-username" autocomplete="username" style="padding-left:40px"><svg class="ic inp-ic" width="16" height="16"><use href="#ic-git"/></svg></div></div>' +
        '<div class="fg"><label>6-Digit Recovery Passcode</label><div class="inp-wrap"><input id="pcCode" type="text" placeholder="000000" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" autocomplete="off" style="padding-left:40px;font-family:var(--font-mn);letter-spacing:4px;font-size:1.1rem;text-align:center"><svg class="ic inp-ic" width="16" height="16"><use href="#ic-key"/></svg></div></div>' +
        '<div style="display:flex;gap:10px;justify-content:flex-end">' +
        '<button class="bg bsm" onclick="closeModal()"><svg class="ic" width="13" height="13"><use href="#ic-x"/></svg> Cancel</button>' +
        '<button class="bs bsm" onclick="verifyPasscode()"><svg class="ic" width="13" height="13"><use href="#ic-check"/></svg> Verify Passcode</button>' +
        '</div>'
      );
      // Add input validation for 6 digits only
      document.getElementById('pcCode').addEventListener('input', function (e) {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
      });
    }

    async function verifyPasscode() {
      var username = document.getElementById('pcUsername').value.trim();
      var passcode = document.getElementById('pcCode').value.trim();

      if (!username || !passcode) return toast('Error', 'Please enter username and passcode', 'error');
      if (!/^\d{6}$/.test(passcode)) return toast('Error', 'Passcode must be exactly 6 digits', 'error');

      try {
        var r = await fetch(API + '/verify-passcode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: username, passcode: passcode })
        });

        if (r.status === 429) return toast('Rate Limited', 'Too many attempts. Please try again in 1 hour.', 'error', 8000);
        if (!r.ok) {
          var msg = await r.text();
          return toast('Error', msg, 'error');
        }

        var data = await r.json();
        closeModal();
        toast('Verified', 'Passcode accepted! Set your new password.', 'success', 3000);
        setTimeout(function () { showNewPasswordModal(data.token); }, 800);
      } catch (err) {
        toast('Error', 'Verification failed: ' + err.message, 'error');
      }
    }

    function showNewPasswordModal(token) {
      openModal(
        '<svg class="ic" width="18" height="18"><use href="#ic-lock"/></svg> Set New Password',
        '<div style="background:rgba(34,201,122,.1);border:1px solid rgba(34,201,122,.3);border-radius:10px;padding:12px;margin-bottom:16px;font-size:.85rem;color:var(--green);line-height:1.6">' +
        '<svg class="ic" width="14" height="14" style="vertical-align:middle;margin-right:6px"><use href="#ic-check"/></svg>' +
        'Passcode verified. Choose a secure password.' +
        '</div>' +
        '<div class="fg"><label>New Password</label><div class="inp-wrap pwd-wrap"><input id="newPwdPC" type="password" placeholder="Min 6 characters" style="padding-left:40px"><svg class="ic inp-ic" width="16" height="16"><use href="#ic-lock"/></svg><button type="button" class="pwd-toggle" onclick="togglePwd(\'newPwdPC\',this)"><svg class="ic" width="16" height="16"><use href="#ic-eye"/></svg></button></div></div>' +
        '<div class="fg"><label>Confirm Password</label><div class="inp-wrap pwd-wrap"><input id="confirmPwdPC" type="password" placeholder="Repeat password" style="padding-left:40px"><svg class="ic inp-ic" width="16" height="16"><use href="#ic-lock"/></svg><button type="button" class="pwd-toggle" onclick="togglePwd(\'confirmPwdPC\',this)"><svg class="ic" width="16" height="16"><use href="#ic-eye"/></svg></button></div></div>' +
        '<button class="bp bfull" onclick="submitPasscodeReset(\'' + token + '\')"><svg class="ic" width="16" height="16"><use href="#ic-check"/></svg> Update Password</button>'
      );
    }

    async function submitPasscodeReset(token) {
      var pwd = document.getElementById('newPwdPC').value;
      var conf = document.getElementById('confirmPwdPC').value;

      if (!pwd || pwd.length < 6) return toast('Error', 'Password must be at least 6 characters', 'error');
      if (pwd !== conf) return toast('Error', 'Passwords do not match', 'error');

      try {
        var r = await fetch(API + '/reset-password-passcode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: token, password: pwd })
        });

        if (!r.ok) {
          var msg = await r.text();
          return toast('Error', msg, 'error');
        }

        closeModal();
        toast('Password Updated', 'You can now log in with your new password', 'success', 6000);
        swTab('login', document.querySelectorAll('.tab')[0]);
      } catch (err) {
        toast('Error', 'Reset failed: ' + err.message, 'error');
      }
    }

    // ── generic modal ─────────────────────────────────────────────
    function openModal(title, body) {
      var m = document.createElement('div');
      m.className = 'mover'; m.id = 'genModal';
      m.innerHTML = '<div class="modal"><div class="mtitle">' + title + '</div>' + body + '</div>';
      document.body.appendChild(m);
      m.addEventListener('click', function (e) { if (e.target === m) closeModal(); });
    }
    function closeModal() { var m = document.getElementById('genModal'); if (m) m.remove(); }

    // ── tabs ──────────────────────────────────────────────────────
    function swTab(t, btn) {
      document.querySelectorAll('.tab').forEach(function (x) { x.classList.remove('on'); });
      if (btn) btn.classList.add('on');
      document.getElementById('loginTab').classList.toggle('hidden', t !== 'login');
      document.getElementById('regTab').classList.toggle('hidden', t !== 'reg');
    }

    // ── register (UPDATED) ────────────────────────────────────────
    async function register() {
      var n = document.getElementById('rn').value.trim();
      var u = document.getElementById('ru').value.trim();
      var e = document.getElementById('re').value.trim();
      var p = document.getElementById('rp').value;
      var pc = document.getElementById('rpc').value.trim(); // NEW: recovery passcode

      if (!n || !u || !e || !p) return toast('Error', 'Name, username, email, and password are required', 'error');
      if (p.length < 6) return toast('Error', 'Password must be at least 6 characters', 'error');
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)) return toast('Error', 'Please enter a valid email address', 'error');

      // Validate passcode if provided
      if (pc && !/^\d{6}$/.test(pc)) return toast('Error', 'Recovery passcode must be exactly 6 digits (or leave empty)', 'error');

      try {
        var r = await fetch(API + '/register', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: u, email: e, full_name: n, password: p, reset_passcode: pc })
        });
        if (!r.ok) { var t2 = await r.text(); return toast('Error', t2, 'error'); }
        toast('Account Created', 'Welcome! Please log in with your credentials.', 'success');
        swTab('login', document.querySelectorAll('.tab')[0]);
        document.getElementById('lu').value = u;
      } catch (err) { toast('Error', err.message, 'error'); }
    }

    // ── login ─────────────────────────────────────────────────────
    async function login() {
      var u = document.getElementById('lu').value.trim();
      var p = document.getElementById('lp').value;
      if (!u || !p) return toast('Error', 'Username and password required', 'error');
      try {
        var r = await fetch(API + '/login', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: u, password: p })
        });
        if (!r.ok) return toast('Error', 'Invalid credentials. Please try again.', 'error');
        var d = await r.json();
        me = d.user;
        localStorage.setItem('me', JSON.stringify(me));
        showApp();
      } catch (err) { toast('Error', 'Login failed: ' + err.message, 'error'); }
    }

    // ── logout ────────────────────────────────────────────────────
    function logout() {
      if (ws) { manualDisc = true; ws.close(); }
      clearInterval(onlineTimer);
      me = null; localStorage.removeItem('me');
      document.getElementById('authSec').classList.remove('hidden');
      document.getElementById('appSec').classList.add('hidden');
      document.getElementById('hdrR').style.display = 'none';
      document.getElementById('auditCard').classList.add('hidden');
      online = []; renderChips();
      addLog('Signed out', 'info');
    }

    // ── show app ──────────────────────────────────────────────────
    function showApp() {
      document.getElementById('authSec').classList.add('hidden');
      document.getElementById('appSec').classList.remove('hidden');
      document.getElementById('hdrR').style.display = 'flex';
      document.getElementById('hdrUser').textContent = '@' + (me.username || '');
      loadNotifs();
      checkPerm();
      auditCount = parseInt(localStorage.getItem('ac') || '0');
      document.getElementById('sAud').textContent = auditCount;
      if (me.username === 'admin') showAdminPanels();
      addLog('Welcome, ' + (me.full_name || me.username), 'success');
      setTimeout(function () { if (!ws || ws.readyState !== WebSocket.OPEN) connectWS(); }, 400);
    }

    function showAdminPanels() {
      ['importCard', 'bcCard', 'userCard', 'fbMgmt', 'statsCard'].forEach(function (id) {
        document.getElementById(id).classList.remove('hidden');
      });
      document.getElementById('scFb').style.display = 'block';
      document.getElementById('fbForm').classList.add('hidden');
      loadUsers(); loadFeedback(); loadStats();
    }

    // ── websocket ─────────────────────────────────────────────────
    function connectWS() {
      if (!me) return;
      addLog('Establishing connection…', 'info');
      ws = new WebSocket(WSS + '/ws?user=' + me.username);
      ws.onopen = function () {
        setConn(true);
        addLog('Connection established', 'success');
        retries = 0; manualDisc = false;
        reqPerm();
        fetchOnline();

        // Start notification sync as safety net
        startNotificationSync();

        clearInterval(onlineTimer);
        onlineTimer = setInterval(fetchOnline, 5000);
      };
      ws.onmessage = function (e) {
        try {
          var d = JSON.parse(e.data);
          addNotif({
            id: d.id, message: d.message, sender: d.sender, time: new Date(), read: false,
            canReply: d.canReply !== false, isReply: d.isReply || false
          });
          addLog(d.sender + ': ' + d.message, 'success');

          if (!d.queued) {
            playSound(d.isReply ? 'reply' : 'audit');
            var title = d.isReply ? ('Reply from @' + d.sender) : ('Audit from @' + d.sender);
            toast(title, d.message, d.isReply ? 'success' : 'audit', 8000);
            deskNotif(d.sender, d.message);
          }
        } catch (err) {
          playSound('audit');
          toast('Notification', e.data, 'audit', 8000);
          addNotif({ message: e.data, sender: 'System', time: new Date(), read: false, canReply: false });
        }
      };
      ws.onclose = function () {
        setConn(false);
        clearInterval(onlineTimer);
        clearInterval(syncTimer); // ADD THIS LINE
        online = []; renderChips();
        if (!manualDisc) {
          var delay = Math.min(1000 * Math.pow(2, retries), 30000);
          addLog('Reconnecting in ' + (delay / 1000) + 's…', 'info');
          setTimeout(connectWS, delay);
          retries++;
        }
      };
      ws.onerror = function () { addLog('WebSocket error', 'error'); };
    }

    function disconnectWS() { manualDisc = true; if (ws) ws.close(); clearInterval(onlineTimer); }

    function setConn(on) {
      document.getElementById('cbadge').className = 'badge ' + (on ? 'b-on' : 'b-off');
      document.getElementById('ctext').textContent = on ? 'Connected' : 'Disconnected';
      var btn = document.getElementById('cbtn');
      if (on) {
        btn.innerHTML = '<svg class="ic" width="16" height="16"><use href="#ic-wifi-off"/></svg> Disconnect';
        btn.className = 'bd bfull';
        btn.onclick = disconnectWS;
      } else {
        btn.innerHTML = '<svg class="ic" width="16" height="16"><use href="#ic-wifi"/></svg> Connect';
        btn.className = 'bp bfull';
        btn.onclick = connectWS;
      }
      document.getElementById('auditCard').classList.toggle('hidden', !on);
    }

    // ── online users ──────────────────────────────────────────────
    // FIX: Send X-Admin-User header so backend returns total count only to admin.
    // The backend connections map is the authoritative source — always accurate.
    async function fetchOnline() {
      try {
        var hdrs = { 'Cache-Control': 'no-cache' };
        if (me && me.username === 'admin') hdrs['X-Admin-User'] = 'admin';
        var r = await fetch(API + '/online?_=' + Date.now(), { cache: 'no-cache', headers: hdrs });
        if (!r.ok) return;
        var d = await r.json();
        online = d.online || [];
        document.getElementById('sOn').textContent = online.length;
        // Only show total registered count when backend returns it (admin only)
        if (d.total !== undefined) {
          document.getElementById('sTot').textContent = d.total;
        }
        renderChips();
        // Refresh user table online badges without a full reload
        if (me && me.username === 'admin') {
          document.getElementById('uOn').textContent = online.length;
          // Update inline status badges using backend's online array
          refreshUserOnlineStatus();
        }
      } catch (err) { }
    }

    // Refreshes the Online/Offline badges in the user table without re-fetching the full list.
    // Uses the online[] array returned by the backend /online endpoint.
    function refreshUserOnlineStatus() {
      if (!userList || !userList.length) return;
      // Update each user's online flag from the fresh online array
      userList.forEach(function (u) { u.online = online.indexOf(u.username) > -1; });
      // Re-render just the status cells without rebuilding the whole table
      var rows = document.querySelectorAll('#uBody tr');
      rows.forEach(function (row) {
        var usernameCell = row.querySelector('td:first-child [style*="font-mn"]');
        if (!usernameCell) return;
        var uname = usernameCell.textContent.replace('@', '').trim();
        var isOn = online.indexOf(uname) > -1;
        var statusCell = row.querySelector('td:nth-child(3)');
        if (statusCell) {
          statusCell.innerHTML = '<span class="badge ' + (isOn ? 'b-on' : 'b-off') + '"><span class="bdot"></span>' + (isOn ? 'Online' : 'Offline') + '</span>';
        }
      });
    }

    function renderChips() {
      var el = document.getElementById('chips');
      if (!online.length) {
        el.innerHTML = '<span style="color:var(--t2);font-size:.875rem">No users online</span>';
        return;
      }
      el.innerHTML = online.map(function (u) {
        return '<div class="chip"><span style="width:7px;height:7px;border-radius:50%;background:var(--green);display:inline-block;box-shadow:0 0 6px var(--green)"></span>' + esc(u) + '</div>';
      }).join('');
    }

    // ── notifications ─────────────────────────────────────────────
    function addNotif(n) {
      notifs.unshift(n); unread++;
      renderBadge(); renderList(); saveNotifs();
    }
    function renderBadge() {
      var b = document.getElementById('nbadge');
      if (unread > 0) { b.textContent = unread > 99 ? '99+' : unread; b.classList.remove('hidden'); }
      else b.classList.add('hidden');
    }
    function renderList() {
      var el = document.getElementById('nlist');
      if (!notifs.length) {
        el.innerHTML = '<div style="padding:40px;text-align:center;color:var(--t2)">No notifications yet</div>';
        return;
      }
      el.innerHTML = notifs.map(function (n) {
        var rb = n.canReply ? ('<button class="rbtn" onclick="event.stopPropagation();openReply(' + (n.id || 0) + ',\'' + esc(n.sender) + '\',\'' + esc(n.message) + '\')"><svg class="ic" width="13" height="13"><use href="#ic-reply"/></svg> Reply</button>') : '';
        var tag = n.isReply ? '<div style="color:var(--cyan);font-size:.72rem;margin-top:4px;display:flex;align-items:center;gap:4px"><svg class="ic" width="11" height="11"><use href="#ic-reply"/></svg> Reply</div>' : '';
        return '<div class="ni ' + (n.read ? '' : 'unread') + '" onclick="markRead(' + (n.id || 0) + ')">' +
          '<div class="ntime">' + timeAgo(n.time) + '</div>' +
          '<div class="nmsg">' + esc(n.message) + '</div>' + rb + tag + '</div>';
      }).join('');
    }
    function togglePanel() {
      var p = document.getElementById('npanel');
      p.classList.toggle('hidden');
      if (!p.classList.contains('hidden')) {
        notifs.forEach(function (n) { n.read = true; });
        unread = 0; renderBadge(); renderList(); saveNotifs();
      }
    }
    function markRead(id) {
      var n = notifs.find(function (x) { return x.id === id; });
      if (n && !n.read) { n.read = true; unread = Math.max(0, unread - 1); renderBadge(); saveNotifs(); }
    }
    function clearNotifs() { notifs = []; unread = 0; renderBadge(); renderList(); saveNotifs(); }
    function saveNotifs() {
      var d = Date.now() - 86400000;
      localStorage.setItem('notifs', JSON.stringify(
        notifs.filter(function (n) { return new Date(n.time) > d; }).slice(0, 50)
      ));
    }
    function loadNotifs() {
      try {
        var s = localStorage.getItem('notifs');
        if (s) {
          notifs = JSON.parse(s).map(function (n) { return Object.assign({}, n, { time: new Date(n.time) }); });
          unread = notifs.filter(function (n) { return !n.read; }).length;
          renderBadge(); renderList();
        }
      } catch (err) { notifs = []; }
    }

    // ── reply modal ───────────────────────────────────────────────
    function openReply(id, sender, origMsg) {
      var m = document.createElement('div');
      m.className = 'mover'; m.id = 'rModal';
      m.innerHTML = '<div class="modal">' +
        '<div class="mtitle"><svg class="ic" width="18" height="18"><use href="#ic-reply"/></svg> Reply to @' + esc(sender) + '</div>' +
        '<div class="origmsg"><strong style="color:var(--t0)">Original message:</strong><br><span style="color:var(--t1)">' + esc(origMsg) + '</span></div>' +
        '<div class="fg"><label>Your Reply</label><textarea id="rTxt" placeholder="Type your reply…"></textarea></div>' +
        '<div style="display:flex;gap:10px;justify-content:flex-end">' +
        '<button class="bg bsm" onclick="closeReply()"><svg class="ic" width="13" height="13"><use href="#ic-x"/></svg> Cancel</button>' +
        '<button class="bs bsm" onclick="sendReply(' + id + ',\'' + esc(sender) + '\')"><svg class="ic" width="13" height="13"><use href="#ic-send"/></svg> Send Reply</button>' +
        '</div></div>';
      document.body.appendChild(m);
      m.addEventListener('click', function (e) { if (e.target === m) closeReply(); });
      document.getElementById('rTxt').focus();
    }
    function closeReply() { var m = document.getElementById('rModal'); if (m) m.remove(); }
    async function sendReply(id, sender) {
      var txt = document.getElementById('rTxt').value.trim();
      if (!txt) return toast('Error', 'Reply cannot be empty', 'error');
      try {
        var r = await fetch(API + '/reply', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notificationId: id, replyMessage: txt, replierUsername: me.username })
        });
        if (!r.ok) throw new Error('Reply failed');
        playSound('success');
        toast('Sent', 'Reply delivered to @' + sender, 'success');
        addLog('Reply sent to @' + sender, 'success');
        closeReply();
        var n = notifs.find(function (x) { return x.id === id; });
        if (n) { n.canReply = false; renderList(); saveNotifs(); }
      } catch (err) { toast('Error', err.message, 'error'); }
    }

    // ── search users (UPDATED to show registered/unregistered) ───
    // SEARCH DROPDOWN (FIXED WITH EVENT DELEGATION - ISSUE #3)
    // ══════════════════════════════════════════════════════════════
    function srchUsers(q) {
      clearTimeout(srchTimer);
      var drop = document.getElementById('sdrop');

      if (!q || q.length < 2) {
        drop.classList.add('hidden');
        return;
      }

      srchTimer = setTimeout(async function () {
        try {
          var r = await fetch(API + '/search?q=' + encodeURIComponent(q));
          if (!r.ok) return;

          var users = await r.json();

          if (!users.length) {
            drop.innerHTML = '<div style="padding:14px;text-align:center;color:var(--t2);font-size:.875rem">No users found</div>';
            drop.classList.remove('hidden');
            return;
          }

          drop.innerHTML = users.map(function (u) {
            if (u.status === 'registered') {
              return '<div class="sitem" data-username="' + esc(u.username) + '" data-status="registered">' +
                '<div style="font-weight:600;font-size:.9rem;color:var(--t0)">' + esc(u.fullName) + '</div>' +
                '<div style="font-size:.78rem;color:var(--t2);font-family:var(--font-mn)">@' + esc(u.username) + '</div>' +
                '</div>';
            } else {
              // Unregistered user
              var dataFloor = u.floor ? ' data-floor="' + esc(u.floor) + '"' : '';
              var dataPhone = u.whatsapp ? ' data-phone="' + esc(u.whatsapp) + '"' : '';
              return '<div class="sitem" data-username="' + esc(u.username) + '" data-status="unregistered"' + dataFloor + dataPhone + ' style="border-left:3px solid var(--amber)">' +
                '<div style="display:flex;align-items:center;gap:6px">' +
                '<svg class="ic" width="14" height="14" style="color:var(--amber)"><use href="#ic-alert"/></svg>' +
                '<span style="font-weight:600;font-size:.9rem;color:var(--t0)">' + esc(u.fullName) + '</span>' +
                '</div>' +
                '<div style="font-size:.78rem;color:var(--t2);font-family:var(--font-mn)">@' + esc(u.username) + ' · Not registered</div>' +
                (u.floor ? '<div style="font-size:.72rem;color:var(--amber);margin-top:2px">🏢 ' + esc(u.floor) + '</div>' : '') +
                '</div>';
            }
          }).join('');

          drop.classList.remove('hidden');

          // CRITICAL FIX: Event delegation instead of inline onclick
          // This prevents z-index and pointer-events conflicts
          drop.querySelectorAll('.sitem').forEach(function (item) {
            item.addEventListener('click', function (e) {
              e.stopPropagation();
              var username = item.getAttribute('data-username');
              var status = item.getAttribute('data-status');

              if (status === 'registered') {
                pickUser(username);
              } else {
                // Show offline/unregistered modal
                var fullName = item.textContent.match(/@(\S+)/)?.[0].replace('@', '') || username;
                var floor = item.getAttribute('data-floor') || '';
                var phone = item.getAttribute('data-phone') || '';

                // Find full user info
                var userInfo = users.find(function (u) { return u.username === username; });
                if (userInfo) showOfflineUserModal(username, userInfo);
              }
            });
          });

        } catch (err) {
          console.error('Search error:', err);
        }
      }, 300);
    }

    function pickUser(u) {
      document.getElementById('tUser').value = u;
      document.getElementById('sdrop').classList.add('hidden');
      document.getElementById('aDetail').focus();

      function showOfflineUserModal(username, userInfo) {
        if (!userInfo) {
          toast('Error', 'User information not available', 'error');
          return;
        }

        var name = userInfo.fullName || username;
        var floor = userInfo.floor || 'Unknown';
        var phone = userInfo.whatsapp || '';
      }

      // Build WhatsApp URL
      var waUrl = '';
      if (phone) {
        var cleanPhone = phone.replace(/\D/g, '');
        var senderName = me && me.full_name ? me.full_name : (me ? me.username : 'Nexus Audit');
        var waText = 'Hi ' + name + (floor !== 'Unknown' ? ' (' + floor + ')' : '') + ',\n\n' +
          'This is ' + senderName + ' reaching out from Nexus Audit.\n\n' +
          'You have been requested for an audit. Please register on the Nexus Audit platform to receive real-time notifications:\n' +
          'https://audit-notification.onrender.com\n\n' +
          'Your registration details:\n- Use your Gitea username: ' + username + '\n\n' +
          'Please confirm receipt of this message.\n\nThank you.';

        waUrl = 'https://wa.me/' + cleanPhone + '?text=' + encodeURIComponent(waText);
      }

      var contactSection = phone ?
        '<a href="' + waUrl + '" target="_blank" rel="noopener noreferrer" class="wa-btn" style="margin-top:16px">' +
        '<svg class="ic" width="15" height="15"><use href="#ic-whatsapp"/></svg> Send WhatsApp Invite' +
        '</a>' :
        '<div style="background:rgba(239,69,101,.1);border:1px solid rgba(239,69,101,.3);padding:10px 14px;border-radius:8px;margin-top:16px;font-size:.85rem;color:var(--red)">' +
        '<svg class="ic" width="14" height="14" style="vertical-align:middle;margin-right:6px"><use href="#ic-alert"/></svg>' +
        'No contact information available for this user.' +
        '</div>';

      openModal(
        '<svg class="ic" width="18" height="18" style="color:var(--amber)"><use href="#ic-alert"/></svg> User Not Available',
        '<div style="text-align:center;padding:10px 0">' +
        '<div style="background:rgba(245,158,58,.08);border:1px solid rgba(245,158,58,.3);border-radius:10px;padding:14px;margin-bottom:20px">' +
        '<div style="font-weight:700;font-size:1.05rem;color:var(--t0);margin-bottom:8px;font-family:var(--font-hd)">' + esc(name) + '</div>' +
        '<div style="display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-top:10px">' +
        '<span class="unreg-pill pill-floor"><svg class="ic" width="11" height="11"><use href="#ic-building"/></svg> ' + esc(floor) + '</span>' +
        (phone ? '<span class="unreg-pill pill-phone"><svg class="ic" width="11" height="11"><use href="#ic-phone"/></svg> ' + esc(phone) + '</span>' : '') +
        '<span style="background:rgba(239,69,101,.12);color:var(--red);border:1px solid rgba(239,69,101,.25);padding:3px 10px;border-radius:20px;font-size:.75rem;font-weight:500;font-family:var(--font-hd)">Not Registered</span>' +
        '</div>' +
        '</div>' +
        '<p style="font-size:.875rem;color:var(--t2);margin-bottom:16px;line-height:1.6">' +
        'This user is not registered on Nexus Audit yet. You can reach them via WhatsApp to request registration.' +
        '</p>' +
        contactSection +
        '<button class="bg bfull" onclick="closeModal()" style="margin-top:16px">' +
        '<svg class="ic" width="14" height="14"><use href="#ic-x"/></svg> Close' +
        '</button>' +
        '</div>'
      );
    }


    // ── send audit (UPDATED for unregistered user detection) ─────
    async function sendAudit() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return toast('Error', 'Please connect first', 'error');
      var target = document.getElementById('tUser').value.trim();
      var detail = document.getElementById('aDetail').value.trim();
      if (!target || !detail) return toast('Error', 'All fields are required', 'error');

      // Check if user is online first
      var isOnline = online.indexOf(target) > -1;

      if (!isOnline) {
        // User is offline — check if they're registered
        try {
          var searchR = await fetch(API + '/search?q=' + encodeURIComponent(target));
          if (searchR.ok) {
            var users = await searchR.json();
            var user = users.find(function (u) { return u.username === target; });

            if (user && user.status === 'unregistered') {
              showOfflineUserModal(target, user);
              return;
            }
          }
        } catch (e) { }

        // Registered but offline — show warning
        if (!confirm(target + ' is currently offline. Send audit anyway? (They will receive it when they connect)')) {
          return;
        }
      }
      try {
        var r = await fetch(API + '/audit', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ targetUser: target, requester: me.username, details: detail })
        });

        var d = await r.json();

        // Handle unregistered user response from backend
        if (d.error === 'user_not_registered' && d.user_info) {
          closeModal();
          showOfflineUserModal(target, {
            fullName: d.user_info.name,
            floor: d.user_info.floor,
            whatsapp: d.user_info.phone,
            status: 'unregistered'
          });
          return;
        }

        if (!r.ok) throw new Error('Send failed');
        toast('Audit Sent', d.message, 'success', 3000);
        addLog('Audit dispatched to @' + target, 'success');
        document.getElementById('tUser').value = '';
        document.getElementById('aDetail').value = '';
        auditCount++; localStorage.setItem('ac', auditCount);
        document.getElementById('sAud').textContent = auditCount;
      } catch (err) { toast('Error', err.message, 'error'); }
    }

    // Show modal for unregistered user with WhatsApp option
    function showUnregisteredUserModal(info) {
      var waBtn = info.whatsapp_url ?
        '<a href="' + info.whatsapp_url + '" target="_blank" rel="noopener noreferrer" class="wa-btn" style="margin-top:16px">' +
        '<svg class="ic" width="15" height="15"><use href="#ic-whatsapp"/></svg> Send WhatsApp Invite' +
        '</a>' :
        '<div style="color:var(--t2);font-size:.85rem;margin-top:12px;text-align:center">No phone number available</div>';

      openModal(
        '<svg class="ic" width="18" height="18" style="color:var(--amber)"><use href="#ic-alert"/></svg> User Not Registered',
        '<div style="text-align:center;padding:10px 0">' +
        '<p style="color:var(--t1);margin-bottom:20px">' +
        '<strong style="color:var(--t0)">' + esc(info.name) + '</strong> is not registered yet, but you can reach them:' +
        '</p>' +
        '<div class="unreg-card" style="margin-bottom:20px">' +
        '<div class="unreg-name">' + esc(info.name) + '</div>' +
        '<div class="unreg-meta">' +
        (info.floor ? '<span class="unreg-pill pill-floor"><svg class="ic" width="11" height="11"><use href="#ic-building"/></svg> ' + esc(info.floor) + '</span>' : '') +
        (info.phone ? '<span class="unreg-pill pill-phone"><svg class="ic" width="11" height="11"><use href="#ic-phone"/></svg> ' + esc(info.phone) + '</span>' : '') +
        '</div>' +
        '</div>' +
        waBtn +
        '<p style="font-size:.8rem;color:var(--t2);margin-top:16px">' +
        'They need to register with their Gitea username to receive audits.' +
        '</p>' +
        '<button class="bg bfull" onclick="closeModal()" style="margin-top:16px">' +
        '<svg class="ic" width="14" height="14"><use href="#ic-x"/></svg> Close' +
        '</button>' +
        '</div>'
      );
    }

    // ── broadcast ─────────────────────────────────────────────────
    async function sendBroadcast() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return toast('Error', 'Please connect first', 'error');
      var target = document.getElementById('bcTarget').value;
      var msg = document.getElementById('bcMsg').value.trim();
      if (!msg) return toast('Error', 'Message is required', 'error');
      if (!confirm('Broadcast to ' + (target === 'online' ? 'all online users' : 'all registered users') + '?')) return;
      try {
        var r = await fetch(API + '/broadcast', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg, sender: me.username, targetType: target })
        });
        if (!r.ok) throw new Error('Failed');
        var d = await r.json();
        toast('Broadcast Sent', d.message, 'success', 5000);
        addLog('Broadcast: ' + d.delivered + ' delivered, ' + d.queued + ' queued', 'success');
        document.getElementById('bcMsg').value = '';
      } catch (err) { toast('Error', err.message, 'error'); }
    }

    // ── feedback (user) ───────────────────────────────────────────
    async function submitFb() {
      var type = document.getElementById('fbT').value;
      var subj = document.getElementById('fbS').value.trim();
      var msg = document.getElementById('fbM').value.trim();
      if (!subj || !msg) return toast('Error', 'Subject and message are required', 'error');
      try {
        var r = await fetch(API + '/feedback', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: me.username, subject: subj, message: msg, type: type })
        });
        if (!r.ok) throw new Error('Submission failed');
        toast('Submitted', 'Your feedback has been sent to admin', 'success', 4000);
        addLog('Feedback submitted', 'success');
        document.getElementById('fbS').value = '';
        document.getElementById('fbM').value = '';
      } catch (err) { toast('Error', err.message, 'error'); }
    }

    // ── import users ──────────────────────────────────────────────
    async function importUsers() {
      var file = document.getElementById('xlFile').files[0];
      var st = document.getElementById('impSt');
      var resultDiv = document.getElementById('importResults');
      if (!file) return;
      var form = new FormData(); form.append('file', file);
      st.innerHTML = '<span style="color:var(--cyan);display:flex;align-items:center;gap:6px"><svg class="ic" width="14" height="14"><use href="#ic-refresh"/></svg> Processing Excel file…</span>';
      resultDiv.classList.add('hidden');
      try {
        var r = await fetch(API + '/import?admin=' + me.username, { method: 'POST', body: form });
        if (!r.ok) throw new Error('Import failed');
        var d = await r.json();
        st.innerHTML = '<span style="color:var(--green);display:flex;align-items:center;gap:6px"><svg class="ic" width="14" height="14"><use href="#ic-check"/></svg> Imported ' + d.imported + ' users · Skipped ' + d.skipped + '</span>';
        toast('Import Complete', d.imported + ' users imported successfully', 'success');
        // Render unregistered users if present
        if (d.unregistered && d.unregistered.length > 0) {
          renderUnregistered(d.unregistered, resultDiv);
        }
        loadUsers();
      } catch (err) {
        st.innerHTML = '<span style="color:var(--red);display:flex;align-items:center;gap:6px"><svg class="ic" width="14" height="14"><use href="#ic-x"/></svg> ' + err.message + '</span>';
        toast('Import Failed', err.message, 'error');
      }
      document.getElementById('xlFile').value = '';
    }

    function renderUnregistered(users, container) {
      container.classList.remove('hidden');
      container.innerHTML =
        '<div style="border-top:1px solid var(--br0);margin-top:16px;padding-top:16px">' +
        '<div style="font-family:var(--font-hd);font-weight:600;color:var(--amber);margin-bottom:4px;display:flex;align-items:center;gap:8px">' +
        '<svg class="ic" width="16" height="16"><use href="#ic-alert"/></svg> ' + users.length + ' Unregistered / No Gitea Account' +
        '</div>' +
        '<div style="font-size:.78rem;color:var(--t2);margin-bottom:14px">These users can be reached via WhatsApp. Their floor location is shown for in-person contact.</div>' +
        users.map(function (u) {
          // Build a professional, URL-encoded WhatsApp message
          var senderName = me && me.full_name ? me.full_name : (me ? me.username : 'Nexus Audit');
          var location = u.floor ? (' (' + u.floor + ')') : '';
          var waText = 'Hi ' + u.name + location + ',\n\n' +
            'This is ' + senderName + ' reaching out from Nexus Audit.\n\n' +
            'You have been requested for an audit. Please register on the Nexus Audit platform to receive real-time notifications:\n' +
            'https://audit-notification.onrender.com\n\n' +
            'Your registration details:\n- Gitea username is required to register\n\n' +
            'Please confirm receipt of this message.\n\nThank you.';
          var phone = u.phone ? u.phone.replace(/\D/g, '') : '';
          var waUrl = phone ? ('https://wa.me/' + '+234' + phone + '?text=' + encodeURIComponent(waText)) : '';
          return '<div class="unreg-card">' +
            '<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px">' +
            '<div>' +
            '<div class="unreg-name">' + esc(u.name) + '</div>' +
            '<div class="unreg-meta">' +
            (u.floor ? '<span class="unreg-pill pill-floor"><svg class="ic" width="11" height="11"><use href="#ic-building"/></svg> ' + esc(u.floor) + '</span>' :
              '<span class="unreg-pill" style="background:rgba(90,112,150,.1);border:1px solid var(--br0);color:var(--t2)"><svg class="ic" width="11" height="11"><use href="#ic-map-pin"/></svg> Floor unknown</span>') +
            (phone ? '<span class="unreg-pill pill-phone"><svg class="ic" width="11" height="11"><use href="#ic-phone"/></svg> ' + esc(u.phone) + '</span>' : '') +
            '</div>' +
            '</div>' +
            (waUrl ?
              '<a href="' + waUrl + '" target="_blank" rel="noopener noreferrer" class="wa-btn">' +
              '<svg class="ic" width="15" height="15"><use href="#ic-whatsapp"/></svg> Send WhatsApp Invite' +
              '</a>' :
              '<span style="color:var(--t2);font-size:.8rem;display:inline-flex;align-items:center;gap:5px;padding:8px">' +
              '<svg class="ic" width="13" height="13"><use href="#ic-alert"/></svg> No phone on record' +
              '</span>') +
            '</div>' +
            '</div>';
        }).join('') +
        '</div>';
    }

    // ── admin: load users ─────────────────────────────────────────
    async function loadUsers() {
      try {
        var r = await fetch(API + '/admin/users', { headers: { 'X-Admin-User': 'admin' } });
        if (!r.ok) throw new Error('Failed');
        var d = await r.json();
        userList = d.users || [];
        renderUsers(userList);
        var today = new Date().toDateString();
        var newT = userList.filter(function (u) { return new Date(u.created_at).toDateString() === today; }).length;
        document.getElementById('uTot').textContent = userList.length;
        document.getElementById('uOn').textContent = online.length;
        document.getElementById('uNew').textContent = newT;
        document.getElementById('sTot').textContent = userList.length;
      } catch (err) { toast('Error', err.message, 'error'); }
    }

    function renderUsers(list) {
      var b = document.getElementById('uBody');
      if (!list || !list.length) {
        b.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--t2)">No users found</td></tr>';
        return;
      }
      b.innerHTML = list.map(function (u) {
        // FIX: use backend's u.online (from connections map), fallback to local array
        var on = u.online === true || (u.online === undefined && online.indexOf(u.username) > -1);
        var ini = u.full_name ? (u.full_name.split(' ').map(function (x) { return x[0] || ''; }).join('').toUpperCase().slice(0, 2)) : '?';
        var joined = new Date(u.created_at).toLocaleDateString();
        var last = u.last_login ? new Date(u.last_login).toLocaleString() : 'Never';
        return '<tr>' +
          '<td><div style="display:flex;align-items:center;gap:10px">' +
          '<div class="uav">' + esc(ini) + '</div>' +
          '<div>' +
          '<div style="font-weight:600;color:var(--t0);font-family:var(--font-hd);font-size:.9rem">' + esc(u.full_name) + '</div>' +
          '<div style="font-size:.75rem;color:var(--t2);font-family:var(--font-mn)">@' + esc(u.username) + '</div>' +
          '</div></div></td>' +
          '<td style="font-size:.8rem">' + esc(u.email) + '</td>' +
          '<td><span class="badge ' + (on ? 'b-on' : 'b-off') + '"><span class="bdot"></span>' + (on ? 'Online' : 'Offline') + '</span></td>' +
          '<td style="font-size:.8rem">' + joined + '</td>' +
          '<td style="font-size:.8rem">' + last + '</td>' +
          '<td style="text-align:center">' +
          '<button class="bg bsm" onclick="qkAudit(\'' + esc(u.username) + '\')" title="Send Audit Request">' +
          '<svg class="ic" width="13" height="13"><use href="#ic-send"/></svg>' +
          '</button>' +
          '</td>' +
          '</tr>';
      }).join('');
    }

    function filterUsers(q) {
      var query = (q || document.getElementById('uSrch').value).toLowerCase();
      var sf = document.getElementById('uFilter').value;
      var res = userList.filter(function (u) {
        var mq = !query || u.username.toLowerCase().indexOf(query) > -1 ||
          u.full_name.toLowerCase().indexOf(query) > -1 || u.email.toLowerCase().indexOf(query) > -1;
        // FIX: use u.online from backend; fallback to local online array
        var isOn = u.online === true || (u.online === undefined && online.indexOf(u.username) > -1);
        var ms = sf === 'all' || (sf === 'online' && isOn) || (sf === 'offline' && !isOn);
        return mq && ms;
      });
      renderUsers(res);
    }

    function exportCSV() {
      var rows = [['Username', 'Full Name', 'Email', 'Status', 'Joined', 'Last Login']];
      userList.forEach(function (u) {
        var isOn = u.online === true || (u.online === undefined && online.indexOf(u.username) > -1);
        rows.push([u.username, u.full_name, u.email,
        isOn ? 'Online' : 'Offline',
        new Date(u.created_at).toLocaleDateString(),
        u.last_login ? new Date(u.last_login).toLocaleString() : 'Never']);
      });
      var csv = rows.map(function (r) { return r.map(function (c) { return '"' + String(c).replace(/"/g, '""') + '"'; }).join(','); }).join('\n');
      var a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
      a.download = 'nexus_users_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
      toast('Exported', 'User list downloaded', 'success', 3000);
    }

    function qkAudit(u) {
      document.getElementById('tUser').value = u;
      document.getElementById('auditCard').scrollIntoView({ behavior: 'smooth' });
      document.getElementById('aDetail').focus();
    }

    // ── admin: feedback ───────────────────────────────────────────
    async function loadFeedback() {
      var type = document.getElementById('fbFilt').value;
      var url = API + '/admin/feedback' + (type && type !== 'all' ? '?type=' + type : '');
      try {
        var r = await fetch(url, { headers: { 'X-Admin-User': 'admin' } });
        if (!r.ok) throw new Error('Failed');
        var d = await r.json();
        renderFeedback(d.feedback || []);
      } catch (err) { toast('Error', err.message, 'error'); }
    }

    function renderFeedback(items) {
      var el = document.getElementById('fbList');
      if (!items || !items.length) {
        el.innerHTML = '<div style="padding:40px;text-align:center;color:var(--t2)">No feedback submitted yet</div>';
        return;
      }
      var typeIcons = { bug: '#ic-alert', feature: '#ic-trending', general: '#ic-message' };
      var typeColors = { bug: 'var(--red)', feature: 'var(--cyan)', general: 'var(--t1)' };
      el.innerHTML = items.map(function (f) {
        var ic = typeIcons[f.type] || '#ic-message';
        var col = typeColors[f.type] || 'var(--t1)';
        var resolved = f.status === 'resolved';
        return '<div class="unreg-card">' +
          '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">' +
          '<div style="display:flex;align-items:center;gap:8px">' +
          '<svg class="ic" width="14" height="14" style="color:' + col + '"><use href="' + ic + '"/></svg>' +
          '<span style="font-weight:600;color:var(--t0);font-family:var(--font-hd)">@' + esc(f.username) + '</span>' +
          '<span style="padding:2px 8px;background:var(--c3);border:1px solid var(--br1);border-radius:4px;font-size:.72rem;color:var(--t1);font-family:var(--font-hd)">' + f.type + '</span>' +
          '<span style="padding:2px 8px;background:' + (resolved ? 'rgba(34,201,122,.12)' : 'rgba(245,158,58,.12)') + ';border-radius:4px;font-size:.72rem;color:' + (resolved ? 'var(--green)' : 'var(--amber)') + ';font-family:var(--font-hd)">' + f.status + '</span>' +
          '</div>' +
          '<span style="font-size:.75rem;color:var(--t2);font-family:var(--font-mn)">' + timeAgo(new Date(f.timestamp)) + '</span>' +
          '</div>' +
          '<div style="font-weight:600;color:var(--t0);font-family:var(--font-hd);margin-bottom:4px">' + esc(f.subject) + '</div>' +
          '<div style="font-size:.875rem;color:var(--t1);margin-bottom:12px;line-height:1.6">' + esc(f.message) + '</div>' +
          '<div style="display:flex;gap:8px">' +
          '<button class="bg bsm" onclick="replyFb(' + f.id + ',\'' + esc(f.username) + '\')"><svg class="ic" width="13" height="13"><use href="#ic-reply"/></svg> Reply</button>' +
          (!resolved ? '<button class="bs bsm" onclick="resolveFb(' + f.id + ')"><svg class="ic" width="13" height="13"><use href="#ic-check"/></svg> Resolve</button>' : '') +
          '</div>' +
          '</div>';
      }).join('');
    }

    async function resolveFb(id) {
      try {
        await fetch(API + '/admin/feedback/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Admin-User': 'admin' },
          body: JSON.stringify({ id: id, status: 'resolved' })
        });
        toast('Resolved', 'Feedback marked as resolved', 'success', 3000);
        loadFeedback();
      } catch (err) { toast('Error', err.message, 'error'); }
    }

    function replyFb(id, username) {
      document.getElementById('tUser').value = username;
      document.getElementById('auditCard').scrollIntoView({ behavior: 'smooth' });
      document.getElementById('aDetail').focus();
      toast('Quick Send', 'Compose an audit reply for @' + username, 'info', 3000);
    }

    // ── admin: stats ──────────────────────────────────────────────
    async function loadStats() {
      try {
        var r = await fetch(API + '/admin/stats', { headers: { 'X-Admin-User': 'admin' } });
        if (!r.ok) throw new Error('Failed');
        var d = await r.json();
        document.getElementById('stU').textContent = d.total_users || 0;
        document.getElementById('stO').textContent = d.online_users || 0;
        document.getElementById('stA').textContent = d.total_audits || 0;
        document.getElementById('stF').textContent = d.pending_feedback || 0;
        document.getElementById('sFb').textContent = d.pending_feedback || 0;
      } catch (err) { toast('Error', err.message, 'error'); }
    }

    // ── notifications permission ──────────────────────────────────
    // FIX: Firefox requires Notification.requestPermission() to be called from
    // a user gesture handler (click). We never auto-call it on load — only on
    // explicit button click. Both promise-based (Chrome/Firefox) and legacy
    // callback (Safari) APIs are handled.
    function checkPerm() {
      var b = document.getElementById('permBanner');
      if (!('Notification' in window)) { b.style.display = 'none'; return; }
      b.style.display = Notification.permission === 'granted' ? 'none' : 'flex';
    }

    function reqPerm() {
      // Guard: Notification API not supported
      if (!('Notification' in window)) {
        toast('Not Supported', 'Your browser does not support desktop notifications', 'info', 4000);
        return;
      }
      // Already granted — nothing to do
      if (Notification.permission === 'granted') {
        document.getElementById('permBanner').style.display = 'none';
        return;
      }
      // Firefox 72+ requires a user-gesture; this function is only called from onclick — safe.
      // requestPermission() returns a Promise in modern browsers; a string in legacy Safari.
      var result = Notification.requestPermission(function (p) {
        // Legacy callback path (older Safari / some mobile browsers)
        if (p === 'granted') toast('Notifications Enabled', 'Desktop alerts are now active', 'success', 3000);
        document.getElementById('permBanner').style.display = 'none';
      });
      // Promise path (Chrome, Firefox, Edge)
      if (result && typeof result.then === 'function') {
        result.then(function (p) {
          if (p === 'granted') {
            toast('Notifications Enabled', 'You will receive alerts for new audits', 'success', 3000);
          } else if (p === 'denied') {
            toast('Notifications Blocked', 'Go to browser settings to allow notifications', 'info', 6000);
          }
          document.getElementById('permBanner').style.display = 'none';
        }).catch(function () {
          document.getElementById('permBanner').style.display = 'none';
        });
      }
    }

    // deskNotif: cross-browser desktop notification with proper error handling.
    // Firefox requires the page to be focused OR the user to have interacted first.
    function deskNotif(sender, message) {
      if (!('Notification' in window) || Notification.permission !== 'granted') return;
      try {
        var opts = {
          body: message,
          tag: 'nexus-audit-' + Date.now(), // unique tag prevents deduplication
          requireInteraction: false
        };
        var n = new Notification('Nexus Audit — @' + sender, opts);
        n.onclick = function () {
          try { window.focus(); } catch (e) { }
          n.close();
        };
        // Auto-close after 8s — Firefox doesn't auto-close
        setTimeout(function () { try { n.close(); } catch (e) { } }, 8000);
      } catch (err) {
        // ServiceWorker path for some Firefox configs
        if (navigator.serviceWorker && navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({
            type: 'SHOW_NOTIFICATION',
            title: 'Nexus Audit — @' + sender,
            body: message
          });
        }
      }
    }

    // ── log ───────────────────────────────────────────────────────
    function addLog(msg, type) {
      var box = document.getElementById('logBox');
      var row = document.createElement('div');
      row.className = 'lr l-' + (type || 'info');
      row.innerHTML = '<span class="lt">[' + new Date().toLocaleTimeString() + ']</span><span class="lm">' + esc(msg) + '</span>';
      box.appendChild(row);
      box.scrollTop = box.scrollHeight;
      if (box.children.length > 100) box.removeChild(box.firstChild);
    }

    // ── toast ─────────────────────────────────────────────────────
    function toast(title, msg, type, dur) {
      if (dur === undefined) dur = 5000;
      var c = document.getElementById('tc');
      var t = document.createElement('div');
      t.className = 'toast ' + (type || 'info');
      var icMap = { success: '#ic-check', error: '#ic-x', warning: '#ic-alert', info: '#ic-info', audit: '#ic-bell' };
      var ic = icMap[type] || '#ic-info';
      t.innerHTML =
        '<div class="ticon"><svg class="ic" width="18" height="18"><use href="' + ic + '"/></svg></div>' +
        '<div class="tbody"><div class="ttitle">' + esc(title) + '</div><div class="tmsg">' + esc(msg) + '</div></div>' +
        '<button class="tcls" onclick="this.parentElement.remove()"><svg class="ic" width="14" height="14"><use href="#ic-x"/></svg></button>';
      c.appendChild(t);
      if (dur > 0) setTimeout(function () { t.style.opacity = '0'; setTimeout(function () { try { t.remove(); } catch (e) { } }, 300); }, dur);
    }

    // ── utils ─────────────────────────────────────────────────────
    function esc(s) {
      if (s == null) return '';
      var d = document.createElement('div');
      d.textContent = String(s);
      return d.innerHTML;
    }
    function timeAgo(d) {
      var diff = Math.floor((Date.now() - new Date(d)) / 1000);
      if (diff < 60) return 'Just now';
      if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
      return new Date(d).toLocaleDateString();
    }

    // ── init ──────────────────────────────────────────────────────
    window.onload = function () {
      // Handle password reset page: /reset-password?token=xxx
      var params = new URLSearchParams(window.location.search);
      var resetToken = params.get('token');
      if (resetToken && window.location.pathname.indexOf('reset-password') > -1) {
        showResetPage(resetToken);
        return;
      }
      try {
        var s = localStorage.getItem('me');
        if (s) { me = JSON.parse(s); showApp(); }
      } catch (err) { localStorage.removeItem('me'); }
    };

    // Error tracking for production debugging
    window.onerror = function (msg, url, line, col, error) {
      console.error('❌ Runtime error:', msg, 'at', url + ':' + line + ':' + col);
      addLog('Error: ' + msg, 'error');
      return false;
    };

    // Unhandled promise rejection
    window.onunhandledrejection = function (event) {
      console.error('❌ Unhandled promise rejection:', event.reason);
      addLog('Promise error: ' + event.reason, 'error');
    };

    // Reset password page — shown when user clicks email link
    function showResetPage(token) {
      document.getElementById('authSec').classList.remove('hidden');
      document.getElementById('authSec').innerHTML =
        '<div class="card" style="max-width:460px;margin:70px auto">' +
        '<div style="text-align:center;margin-bottom:22px">' +
        '<div style="width:56px;height:56px;background:linear-gradient(135deg,var(--cyan),var(--blue2));border-radius:14px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;box-shadow:0 0 24px var(--cyan-gl)">' +
        '<svg class="ic" width="26" height="26" style="color:#fff"><use href="#ic-key"/></svg>' +
        '</div>' +
        '<div style="font-family:var(--font-hd);font-size:1.3rem;font-weight:700;letter-spacing:-.02em">Set New Password</div>' +
        '<div style="color:var(--t2);font-size:.875rem;margin-top:4px">Enter your new password below</div>' +
        '</div>' +
        '<div class="fg"><label>New Password</label>' +
        '<div class="inp-wrap pwd-wrap">' +
        '<input id="newPwd" type="password" placeholder="Min 6 characters" style="padding-left:40px">' +
        '<svg class="ic inp-ic" width="16" height="16"><use href="#ic-lock"/></svg>' +
        '<button type="button" class="pwd-toggle" onclick="togglePwd(\'newPwd\',this)"><svg class="ic" width="16" height="16"><use href="#ic-eye"/></svg></button>' +
        '</div></div>' +
        '<div class="fg"><label>Confirm Password</label>' +
        '<div class="inp-wrap pwd-wrap">' +
        '<input id="confirmPwd" type="password" placeholder="Repeat password" style="padding-left:40px">' +
        '<svg class="ic inp-ic" width="16" height="16"><use href="#ic-lock"/></svg>' +
        '<button type="button" class="pwd-toggle" onclick="togglePwd(\'confirmPwd\',this)"><svg class="ic" width="16" height="16"><use href="#ic-eye"/></svg></button>' +
        '</div></div>' +
        '<button class="bp bfull" onclick="submitReset(\'' + token + '\')">' +
        '<svg class="ic" width="16" height="16"><use href="#ic-check"/></svg> Update Password' +
        '</button>' +
        '</div>';
    }

    async function submitReset(token) {
      var pwd = document.getElementById('newPwd').value;
      var conf = document.getElementById('confirmPwd').value;
      if (!pwd || pwd.length < 6) return toast('Error', 'Password must be at least 6 characters', 'error');
      if (pwd !== conf) return toast('Error', 'Passwords do not match', 'error');
      try {
        var r = await fetch(API + '/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: token, password: pwd })
        });
        var msg = await r.text();
        if (!r.ok) return toast('Error', msg, 'error');
        toast('Password Updated', 'You can now log in with your new password', 'success', 6000);
        setTimeout(function () { window.location.href = '/'; }, 2500);
      } catch (err) { toast('Error', 'Reset failed: ' + err.message, 'error'); }
    }

    document.addEventListener('click', function (e) {
      var panel = document.getElementById('npanel');
      var bell = document.querySelector('.nbell');
      if (panel && !panel.contains(e.target) && bell && !bell.contains(e.target))
        panel.classList.add('hidden');
      var drop = document.getElementById('sdrop');
      var wrap = document.querySelector('.swrap');
      if (drop && wrap && !wrap.contains(e.target))
        drop.classList.add('hidden');
    });
  </script>
</body>

</html>